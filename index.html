<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="一个游戏程序员的blog">
<meta name="keywords" content="game;program;render;PBR;">
<meta property="og:type" content="website">
<meta property="og:title" content="Stoner">
<meta property="og:url" content="http://noleafnolife.com/index.html">
<meta property="og:site_name" content="Stoner">
<meta property="og:description" content="一个游戏程序员的blog">
<meta property="og:locale" content="en">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Stoner">
<meta name="twitter:description" content="一个游戏程序员的blog">






  <link rel="canonical" href="http://noleafnolife.com/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Stoner</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Stoner</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">做此刻最想做的事</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home menu-item-active">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/1.1.Instance/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nolife">
      <meta itemprop="description" content="一个游戏程序员的blog">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stoner">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/05/sdk/graphics/vulkan/1.1.Instance/" class="post-title-link" itemprop="url">Instance</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-05 21:16:00 / Modified: 21:17:35" itemprop="dateCreated datePublished" datetime="2019-04-05T21:16:00+08:00">2019-04-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/" itemprop="url" rel="index"><span itemprop="name">sdk</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/vulkan/" itemprop="url" rel="index"><span itemprop="name">vulkan</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h2 id="Instance"><a href="#Instance" class="headerlink" title="Instance"></a>Instance</h2><h3 id="Extensions"><a href="#Extensions" class="headerlink" title="Extensions"></a>Extensions</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> extensions_count = <span class="number">0</span>;</span><br><span class="line">vkEnumerateInstanceExtensionProperties( <span class="literal">nullptr</span>,</span><br><span class="line">&amp;extensions_count, <span class="literal">nullptr</span> ).</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;VkExtensionProperties&gt; available_extensions(extensions_count);</span><br><span class="line">vkEnumerateInstanceExtensionProperties( <span class="literal">nullptr</span>,</span><br><span class="line">&amp;extensions_count, &amp;available_extensions[<span class="number">0</span>]).</span><br><span class="line"><span class="comment">//check extensions</span></span><br></pre></td></tr></table></figure>
<h3 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">VkApplicationInfo</span><br><span class="line">VkInstanceCreateInfo</span><br><span class="line">vkCreateInstance(</span><br><span class="line"><span class="keyword">const</span> VkInstanceCreateInfo*  pCreateInfo,</span><br><span class="line"><span class="keyword">const</span> VkAllocationCallbacks* pAllocator,<span class="comment">//important，产品级都要使用内存管理器</span></span><br><span class="line">VkInstance*                  pInstance);</span><br></pre></td></tr></table></figure>
<h3 id="重要属性-TODO"><a href="#重要属性-TODO" class="headerlink" title="重要属性 TODO"></a>重要属性 TODO</h3><h3 id="销毁"><a href="#销毁" class="headerlink" title="销毁"></a>销毁</h3>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/11.Lighting/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nolife">
      <meta itemprop="description" content="一个游戏程序员的blog">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stoner">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/05/sdk/graphics/vulkan/11.Lighting/" class="post-title-link" itemprop="url">Lighting</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-05 21:16:00 / Modified: 21:20:38" itemprop="dateCreated datePublished" datetime="2019-04-05T21:16:00+08:00">2019-04-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/" itemprop="url" rel="index"><span itemprop="name">sdk</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/vulkan/" itemprop="url" rel="index"><span itemprop="name">vulkan</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="Lighting"><a href="#Lighting" class="headerlink" title="Lighting"></a>Lighting</h1><h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><blockquote>
<ul>
<li>Rendering a geometry with a vertex diffuse lighting</li>
<li>Rendering a geometry with a fragment specular lighting</li>
<li>Rendering a normal mapped geometry</li>
<li>Drawing a reflective and refractive geometry using cubemaps</li>
<li>Adding shadows to the scene</li>
</ul>
</blockquote>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>…</p>
<h3 id="Rendering-a-geometry-with-a-vertex-diffuse-lighting"><a href="#Rendering-a-geometry-with-a-vertex-diffuse-lighting" class="headerlink" title="Rendering a geometry with a vertex diffuse lighting"></a>Rendering a geometry with a vertex diffuse lighting</h3><p>vertex</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec4 app_position;</span><br><span class="line">layout( location = <span class="number">1</span> ) in vec3 app_normal;</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">0</span> ) uniform UniformBuffer &#123;</span><br><span class="line">    mat4 ModelViewMatrix;</span><br><span class="line">    mat4 ProjectionMatrix;</span><br><span class="line">&#125;;</span><br><span class="line">layout( location = <span class="number">0</span> ) out <span class="keyword">float</span> vert_color;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    gl_Position = ProjectionMatrix * ModelViewMatrix *</span><br><span class="line">        app_position;</span><br><span class="line">    vec3 normal = mat3( ModelViewMatrix ) * app_normal;</span><br><span class="line">    vert_color = max( <span class="number">0.0</span>, dot( normal, vec3( <span class="number">0.58</span>, <span class="number">0.58</span>, <span class="number">0.58</span> ) )</span><br><span class="line">                    ) + <span class="number">0.1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>fragment</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in <span class="keyword">float</span> vert_color;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec4 frag_color;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    frag_color = vec4( vert_color );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>…</p>
<h3 id="Rendering-a-geometry-with-a-fragment-specular-lighting"><a href="#Rendering-a-geometry-with-a-fragment-specular-lighting" class="headerlink" title="Rendering a geometry with a fragment specular lighting"></a>Rendering a geometry with a fragment specular lighting</h3><p><img src="media/phonglighting.png" alt></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec3 vert_position;</span><br><span class="line">layout( location = <span class="number">1</span> ) in vec3 vert_normal;</span><br><span class="line">layout( push_constant ) uniform LightParameters &#123;</span><br><span class="line">    vec4 Position;</span><br><span class="line">&#125; Light;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec4 frag_color;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vec3 normal_vector = normalize( vert_normal );</span><br><span class="line">    vec3 light_vector = normalize( Light.Position.xyz -</span><br><span class="line">                                  vert_position );</span><br><span class="line">    <span class="keyword">float</span> diffuse_term = max( <span class="number">0.0</span>, dot( normal_vector, light_vector</span><br><span class="line">                                      ) );</span><br><span class="line">    frag_color = vec4( diffuse_term + <span class="number">0.1</span> );</span><br><span class="line">    <span class="keyword">if</span>( diffuse_term &gt; <span class="number">0.0</span> ) &#123;</span><br><span class="line">        vec3 view_vector = normalize( vec3( <span class="number">0.0</span>, <span class="number">0.0</span>, <span class="number">0.0</span> ) -</span><br><span class="line">                                     vert_position.xyz );</span><br><span class="line">        vec3 half_vector = normalize( view_vector + light_vector );</span><br><span class="line">        <span class="keyword">float</span> shinniness = <span class="number">60.0</span>;</span><br><span class="line">        <span class="keyword">float</span> specular_term = <span class="built_in">pow</span>( dot( half_vector, normal_vector ),</span><br><span class="line">                                  shinniness );</span><br><span class="line">        frag_color += vec4( specular_term );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="normal-mapeed-geometry"><a href="#normal-mapeed-geometry" class="headerlink" title="normal mapeed geometry"></a>normal mapeed geometry</h3><p>vertex</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec4 app_position;</span><br><span class="line">layout( location = <span class="number">1</span> ) in vec3 app_normal;</span><br><span class="line">layout( location = <span class="number">2</span> ) in vec2 app_texcoord;</span><br><span class="line">layout( location = <span class="number">3</span> ) in vec3 app_tangent;</span><br><span class="line">layout( location = <span class="number">4</span> ) in vec3 app_bitangent;</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">0</span> ) uniform UniformBuffer &#123;</span><br><span class="line">    mat4 ModelViewMatrix;</span><br><span class="line">    mat4 ProjectionMatrix;</span><br><span class="line">&#125;;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec3 vert_position;</span><br><span class="line">layout( location = <span class="number">1</span> ) out vec2 vert_texcoord;</span><br><span class="line">layout( location = <span class="number">2</span> ) out vec3 vert_normal;</span><br><span class="line">layout( location = <span class="number">3</span> ) out vec3 vert_tanget;</span><br><span class="line">layout( location = <span class="number">4</span> ) out vec3 vert_bitanget;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vec4 position = ModelViewMatrix * app_position;</span><br><span class="line">    gl_Position = ProjectionMatrix * position;</span><br><span class="line">    vert_position = position.xyz;</span><br><span class="line">    vert_texcoord = app_texcoord;</span><br><span class="line">    vert_normal = mat3( ModelViewMatrix ) * app_normal;</span><br><span class="line">    vert_tanget = mat3( ModelViewMatrix ) * app_tangent;</span><br><span class="line">    vert_bitanget = mat3( ModelViewMatrix ) * app_bitangent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>fragment</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec3 vert_position;</span><br><span class="line">layout( location = <span class="number">1</span> ) in vec2 vert_texcoord;</span><br><span class="line">layout( location = <span class="number">2</span> ) in vec3 vert_normal;</span><br><span class="line">layout( location = <span class="number">3</span> ) in vec3 vert_tanget;</span><br><span class="line">layout( location = <span class="number">4</span> ) in vec3 vert_bitanget;</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">1</span> ) uniform sampler2D ImageSampler;</span><br><span class="line">layout( push_constant ) uniform LightParameters &#123;</span><br><span class="line">    vec4 Position;</span><br><span class="line">&#125; Light;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec4 frag_color;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vec3 normal = <span class="number">2</span> * texture( ImageSampler, vert_texcoord ).rgb -</span><br><span class="line">        <span class="number">1.0</span>;</span><br><span class="line">    vec3 normal_vector = normalize( mat3( vert_tanget,</span><br><span class="line">                                         vert_bitanget, vert_normal) * normal );</span><br><span class="line">    vec3 light_vector = normalize( Light.Position.xyz -</span><br><span class="line">                                  vert_position );</span><br><span class="line">    <span class="keyword">float</span> diffuse_term = max( <span class="number">0.0</span>, dot( normal_vector, light_vector</span><br><span class="line">                                      ) ) * max( <span class="number">0.0</span>, dot( vert_normal, light_vector ) );</span><br><span class="line">    frag_color = vec4( diffuse_term + <span class="number">0.1</span> );</span><br><span class="line">    <span class="keyword">if</span>( diffuse_term &gt; <span class="number">0.0</span> ) &#123;</span><br><span class="line">        vec3 half_vector = normalize(normalize( -vert_position.xyz )</span><br><span class="line">                                     + light_vector);</span><br><span class="line">        <span class="keyword">float</span> specular_term = <span class="built_in">pow</span>( dot( half_vector, normal_vector ),</span><br><span class="line">                                  <span class="number">60.0</span> );</span><br><span class="line">        frag_color += vec4( specular_term );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Drawing-a-reflective-and-refractive-geometry-using-cubemaps"><a href="#Drawing-a-reflective-and-refractive-geometry-using-cubemaps" class="headerlink" title="Drawing a reflective and refractive geometry using cubemaps"></a>Drawing a reflective and refractive geometry using cubemaps</h3><p><img src="media/cubemap.png" alt></p>
<p>order:+X,-X,+Y,-Y,+Z,-Z</p>
<p>vertex</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec4 app_position;</span><br><span class="line">layout( location = <span class="number">1</span> ) in vec3 app_normal;</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">0</span> ) uniform UniformBuffer &#123;</span><br><span class="line">    mat4 ModelViewMatrix;</span><br><span class="line">    mat4 ProjectionMatrix;</span><br><span class="line">&#125;;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec3 vert_position;</span><br><span class="line">layout( location = <span class="number">1</span> ) out vec3 vert_normal;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vert_position = app_position.xyz;</span><br><span class="line">    vert_normal = app_normal;</span><br><span class="line">    gl_Position = ProjectionMatrix * ModelViewMatrix *</span><br><span class="line">        app_position;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>fragment</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec3 vert_position;</span><br><span class="line">layout( location = <span class="number">1</span> ) in vec3 vert_normal;</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">1</span> ) uniform samplerCube Cubemap;</span><br><span class="line">layout( push_constant ) uniform LightParameters &#123;</span><br><span class="line">    vec4 Position;</span><br><span class="line">&#125; Camera;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec4 frag_color;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vec3 view_vector = vert_position - Camera.Position.xyz;</span><br><span class="line">    <span class="keyword">float</span> angle = smoothstep( <span class="number">0.3</span>, <span class="number">0.7</span>, dot( normalize( -</span><br><span class="line">                                                       view_vector ), vert_normal ) );</span><br><span class="line">    vec3 reflect_vector = reflect( view_vector, vert_normal );</span><br><span class="line">    vec4 reflect_color = texture( Cubemap, reflect_vector );</span><br><span class="line">    vec3 refrac_vector = refract( view_vector, vert_normal, <span class="number">0.3</span> );</span><br><span class="line">    vec4 refract_color = texture( Cubemap, refrac_vector );</span><br><span class="line">    frag_color = mix( reflect_color, refract_color, angle );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="add-shadow-to-the-scene"><a href="#add-shadow-to-the-scene" class="headerlink" title="add shadow to the scene"></a>add shadow to the scene</h3>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/10.HelperRecipes/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nolife">
      <meta itemprop="description" content="一个游戏程序员的blog">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stoner">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/05/sdk/graphics/vulkan/10.HelperRecipes/" class="post-title-link" itemprop="url">Helper Recipes</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-05 21:16:00 / Modified: 21:20:29" itemprop="dateCreated datePublished" datetime="2019-04-05T21:16:00+08:00">2019-04-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/" itemprop="url" rel="index"><span itemprop="name">sdk</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/vulkan/" itemprop="url" rel="index"><span itemprop="name">vulkan</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="10-Helper-Recipes"><a href="#10-Helper-Recipes" class="headerlink" title="10.Helper Recipes"></a>10.Helper Recipes</h1><p>[TOC]</p>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><p>Preparing a translation matrix<br>Preparing a rotation matrix<br>Preparing a scaling matrix<br>Preparing a perspective projection matrix<br>Preparing an orthographic projection matrix<br>Loading texture data from a file<br>Loading a 3D model from an OBJ file</p>
<h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><h2 id="matrix"><a href="#matrix" class="headerlink" title="matrix"></a>matrix</h2><h3 id="translation-matrix"><a href="#translation-matrix" class="headerlink" title="translation matrix"></a>translation matrix</h3><p>关于vulkan 坐标系x (lef/rightt), y (down/up), and z (near/far).右手坐标系</p>
<p><img src="media/coordinate.png" alt></p>
<p>关于矩阵</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="keyword">float</span>, 16&gt; translation_matrix = &#123;</span><br><span class="line">    <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span>, <span class="number">0.0f</span>,</span><br><span class="line">    x, y, z, <span class="number">1.0f</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">return</span> translation_matrix;</span><br></pre></td></tr></table></figure>
<p>All elements initialize with a 0.0f value<br>0th, 5th, 10th, and 15th elements (main diagonal) with a 1.0f value<br>12th element with a value stored in the x variable<br>13th element with a value stored in the y variable<br>14th element with a value stored in the z variable</p>
<p>也就是列主序</p>
<p><img src="media/matrix.png" alt></p>
<h3 id="rotation-matrix"><a href="#rotation-matrix" class="headerlink" title="rotation matrix"></a>rotation matrix</h3><p>0th element with a x <em> x </em> (1.0f - c) + c<br>1st element with a y <em> x </em> (1.0f - c) - z <em> s<br>2nd element with a z </em> x <em> (1.0f - c) + y </em> s<br>4th element with a x <em> y </em> (1.0f - c) + z <em> s<br>5th element with a y </em> y <em> (1.0f - c) + c<br>6th element with a z </em> y <em> (1.0f - c) - x </em> s<br>8th element with a x <em> z </em> (1.0f - c) - y <em> s<br>9th element with a y </em> z <em> (1.0f - c) + x </em> s<br>10th element with a z <em> z </em> (1.0f - c) + c<br>The rest of the elements initialize with a 0.0f value<br>Except for the 15th element, which should contain a 1.0f value</p>
<p>Each column of such matrix defines the directions of x, y, and z axes respectively after the rotation is performed.</p>
<p><img src="media/rotationmatrix.png" alt></p>
<p><img src="media/rotationmatrixcoordinate.png" alt></p>
<p>一个例子</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( normalize ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="keyword">float</span>, 3&gt; normalized = Normalize( x, y, z );</span><br><span class="line">    x = normalized[<span class="number">0</span>];</span><br><span class="line">    y = normalized[<span class="number">1</span>];</span><br><span class="line">    z = normalized[<span class="number">2</span>];</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">float</span> c = <span class="built_in">cos</span>( Deg2Rad( angle ) );</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">float</span> _1_c = <span class="number">1.0f</span> - c;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">float</span> s = <span class="built_in">sin</span>( Deg2Rad( angle ) );</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="keyword">float</span>, 16&gt; rotation_matrix = &#123;</span><br><span class="line">    x * x * _1_c + c,</span><br><span class="line">    y * x * _1_c - z * s,</span><br><span class="line">    z * x * _1_c + y * s,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    x * y * _1_c + z * s,</span><br><span class="line">    y * y * _1_c + c,</span><br><span class="line">    z * y * _1_c - x * s,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    x * z * _1_c - y * s,</span><br><span class="line">    y * z * _1_c + x * s,</span><br><span class="line">    z * z * _1_c + c,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">1.0f</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">return</span> rotation_matrix;</span><br></pre></td></tr></table></figure>
<h3 id="Preparing-a-scaling-matrix"><a href="#Preparing-a-scaling-matrix" class="headerlink" title="Preparing a scaling matrix"></a>Preparing a scaling matrix</h3><blockquote>
<ul>
<li>All elements initialize with a 0.0f value</li>
<li>0th element with a value stored in the x variable</li>
<li>5th element with a value stored in the y variable</li>
<li>10th element with a value stored in the z variable</li>
<li>15th element with a 1.0f value</li>
</ul>
</blockquote>
<p><img src="media/scalematrix.png" alt></p>
<p>..</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">array</span>&lt;<span class="keyword">float</span>, 16&gt; scaling_matrix = &#123;</span><br><span class="line">    x, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>, y, <span class="number">0.0f</span>, <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>, <span class="number">0.0f</span>, z, <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">return</span> scaling_matrix;</span><br></pre></td></tr></table></figure>
<h3 id="Preparing-a-perspective-projection-matrix"><a href="#Preparing-a-perspective-projection-matrix" class="headerlink" title="Preparing a perspective projection matrix"></a>Preparing a perspective projection matrix</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> aspect_ratio;<span class="comment">//width/height</span></span><br><span class="line"><span class="keyword">float</span> field_of_view;<span class="comment">//Initialize it with an angle (in radians) of a vertical field of view of a camera</span></span><br><span class="line"><span class="keyword">float</span> near_plane;</span><br><span class="line"><span class="keyword">float</span> far_plane;</span><br><span class="line"><span class="keyword">float</span> f = (<span class="number">1.0f</span> / <span class="built_in">tan</span>(Deg2Rad(<span class="number">0.5f</span> * field_of_view)));</span><br><span class="line">Matrix4x4 perspective_projection_matrix = &#123;</span><br><span class="line">    f / aspect_ratio,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    -f,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    far_plane / (near_plane - far_plane),</span><br><span class="line">    <span class="number">-1.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    (near_plane * far_plane) / (near_plane - far_plane),</span><br><span class="line">    <span class="number">0.0f</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">return</span> perspective_projection_matrix;</span><br></pre></td></tr></table></figure>
<blockquote>
<ul>
<li>0th element with a f / aspect_ratio</li>
<li>5th element with a -f</li>
<li>10th element with a far_plane / (near_plane - far_plane)</li>
<li>11th element with a -1.0f value</li>
<li>14th element with a (near_plane * far_plane) / (near_plane -<br>far_plane)</li>
<li>The rest of the elements initialize with a 0.0f value</li>
</ul>
</blockquote>
<h3 id="Preparing-an-orthographic-projection-matrix"><a href="#Preparing-an-orthographic-projection-matrix" class="headerlink" title="Preparing an orthographic projection matrix"></a>Preparing an orthographic projection matrix</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Matrix4x4 orthographic_projection_matrix = &#123;</span><br><span class="line">    <span class="number">2.0f</span> / (right_plane - left_plane),</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">2.0f</span> / (bottom_plane - top_plane),</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    <span class="number">1.0f</span> / (near_plane - far_plane),</span><br><span class="line">    <span class="number">0.0f</span>,</span><br><span class="line">    -(right_plane + left_plane) / (right_plane - left_plane),</span><br><span class="line">    -(bottom_plane + top_plane) / (bottom_plane - top_plane),</span><br><span class="line">    near_plane / (near_plane - far_plane),</span><br><span class="line">    <span class="number">1.0f</span></span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">return</span> orthographic_projection_matrix;</span><br></pre></td></tr></table></figure>
<h3 id="Loading-texture-data"><a href="#Loading-texture-data" class="headerlink" title="Loading texture data"></a>Loading texture data</h3><p>stb</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> width = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> height = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">int</span> num_components = <span class="number">0</span>;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">unique_ptr</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>, <span class="keyword">void</span>(*)(<span class="keyword">void</span>*)&gt; stbi_data( stbi_load(</span><br><span class="line">    filename, &amp;width, &amp;height, &amp;num_components, num_requested_components ),</span><br><span class="line">                                                         stbi_image_free );</span><br><span class="line"><span class="keyword">if</span>( (!stbi_data) ||</span><br><span class="line">   (<span class="number">0</span> &gt;= width) ||</span><br><span class="line">   (<span class="number">0</span> &gt;= height) ||</span><br><span class="line">   (<span class="number">0</span> &gt;= num_components) ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not read image!"</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span>&gt; image_data;</span><br><span class="line"><span class="keyword">int</span> data_size = width * height * (<span class="number">0</span> &lt; num_requested_components ?</span><br><span class="line">                                  num_requested_components : num_components);</span><br><span class="line">image_data.resize( data_size );</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">memcpy</span>( image_data.data(), stbi_data.get(), data_size );</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h3 id="3D-model-obj-file"><a href="#3D-model-obj-file" class="headerlink" title="3D model obj file"></a>3D model obj file</h3><p><a href="https://github.com/syoyo/tinyobjloader" target="_blank" rel="noopener">https://github.com/syoyo/tinyobjloader</a>.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> ...</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> TINYOBJLOADER_IMPLEMENTATION</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">"tiny_obj_loader.h"</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Mesh</span> &#123;</span></span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">float</span>&gt; Data;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Part</span> &#123;</span></span><br><span class="line">        <span class="keyword">uint32_t</span> VertexOffset;</span><br><span class="line">        <span class="keyword">uint32_t</span> VertexCount;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;Part&gt; Parts;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">tinyobj::<span class="keyword">attrib_t</span> attribs;</span><br><span class="line"><span class="built_in">std</span>::vectortinyobj::<span class="keyword">shape_t</span> shapes;</span><br><span class="line"><span class="built_in">std</span>::vectortinyobj::<span class="keyword">material_t</span> materials;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">string</span> error;</span><br><span class="line"><span class="keyword">bool</span> result = tinyobj::LoadObj( &amp;attribs, &amp;shapes, &amp;materials, &amp;error,</span><br><span class="line">                               filename.c_str() );</span><br><span class="line"><span class="keyword">if</span>( !result ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not open '"</span> &lt;&lt; filename &lt;&lt; <span class="string">"' file."</span>;</span><br><span class="line">    <span class="keyword">if</span>( <span class="number">0</span> &lt; error.size() ) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">" "</span> &lt;&lt; error;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Mesh mesh = &#123;&#125;;</span><br><span class="line"><span class="keyword">uint32_t</span> offset = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span>( <span class="keyword">auto</span> &amp; shape : shapes ) &#123;</span><br><span class="line">    <span class="keyword">uint32_t</span> part_offset = offset;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">auto</span> &amp; index : shape.mesh.indices ) &#123;</span><br><span class="line">        mesh.Data.emplace_back( attribs.vertices[<span class="number">3</span> * index.vertex_index + <span class="number">0</span>] );</span><br><span class="line">        mesh.Data.emplace_back( attribs.vertices[<span class="number">3</span> * index.vertex_index + <span class="number">1</span>] );</span><br><span class="line">        mesh.Data.emplace_back( attribs.vertices[<span class="number">3</span> * index.vertex_index + <span class="number">2</span>] );</span><br><span class="line">        ++offset;</span><br><span class="line">        <span class="keyword">if</span>( (load_normals) &amp;&amp;</span><br><span class="line">           (attribs.normals.size() &gt; <span class="number">0</span>) ) &#123;</span><br><span class="line">            mesh.Data.emplace_back( attribs.normals[<span class="number">3</span>index.normal_index+<span class="number">0</span>]);</span><br><span class="line">            mesh.Data.emplace_back( attribs.normals[<span class="number">3</span>index.normal_index+<span class="number">1</span>]);</span><br><span class="line">            mesh.Data.emplace_back( attribs.normals[<span class="number">3</span>*index.normal_index+<span class="number">2</span>]);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>( (load_texcoords) &amp;&amp;</span><br><span class="line">           (attribs.texcoords.size() &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">            mesh.Data.emplace_back( attribs.texcoords[<span class="number">2</span> * index.texcoord_index +</span><br><span class="line">                                                      <span class="number">0</span>] );</span><br><span class="line">            mesh.Data.emplace_back( attribs.texcoords[<span class="number">2</span> * index.texcoord_index +</span><br><span class="line">                                                      <span class="number">1</span>] );</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">uint32_t</span> part_vertex_count = offset - part_offset;</span><br><span class="line">    <span class="keyword">if</span>( <span class="number">0</span> &lt; part_vertex_count ) &#123;</span><br><span class="line">        mesh.Parts.push_back( &#123; part_offset, part_vertex_count &#125; );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/12.AdvancedRenderingTechniques/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nolife">
      <meta itemprop="description" content="一个游戏程序员的blog">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stoner">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/05/sdk/graphics/vulkan/12.AdvancedRenderingTechniques/" class="post-title-link" itemprop="url">Advanced Rendering Techniques</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-05 21:16:00 / Modified: 21:20:45" itemprop="dateCreated datePublished" datetime="2019-04-05T21:16:00+08:00">2019-04-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/" itemprop="url" rel="index"><span itemprop="name">sdk</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/vulkan/" itemprop="url" rel="index"><span itemprop="name">vulkan</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="Advanced-Rendering-Techniques"><a href="#Advanced-Rendering-Techniques" class="headerlink" title="Advanced Rendering Techniques"></a>Advanced Rendering Techniques</h1><p>[TOC]</p>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><blockquote>
<ul>
<li>Drawing a skybox</li>
<li>Drawing billboards using geometry shaders</li>
<li>Drawing particles using compute and graphics pipelines</li>
<li>Rendering a tessellated terrain</li>
<li>Rendering a full-screen quad for post-processing</li>
<li>Using input attachments for a color correction post-process effect</li>
</ul>
</blockquote>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><img src="media/cubemap.png" alt></p>
<p>order:right,left,up,down,backward,forward</p>
<p>vertex</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec4 app_position;</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">0</span> ) uniform UniformBuffer &#123;</span><br><span class="line">    mat4 ModelViewMatrix;</span><br><span class="line">    mat4 ProjectionMatrix;</span><br><span class="line">&#125;;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec3 vert_texcoord;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vec3 position = mat3(ModelViewMatrix) * app_position.xyz;</span><br><span class="line">    gl_Position = (ProjectionMatrix * vec4( position, <span class="number">0.0</span> )).xyzz;</span><br><span class="line">    vert_texcoord = app_position.xyz;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>fragment</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec3 vert_texcoord;</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">1</span> ) uniform samplerCube Cubemap;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec4 frag_color;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    frag_color = texture( Cubemap, vert_texcoord );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Drawing-billboards-using-geometry-shaders"><a href="#Drawing-billboards-using-geometry-shaders" class="headerlink" title="Drawing billboards using geometry shaders"></a>Drawing billboards using geometry shaders</h2><p>geometry shader</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( points ) in;</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">0</span> ) uniform UniformBuffer &#123;</span><br><span class="line">    mat4 ModelViewMatrix;</span><br><span class="line">    mat4 ProjectionMatrix;</span><br><span class="line">&#125;;</span><br><span class="line">layout( triangle_strip, max_vertices = <span class="number">4</span> ) out;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec2 geom_texcoord;</span><br><span class="line"><span class="keyword">const</span> <span class="keyword">float</span> SIZE = <span class="number">0.1</span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vec4 position = gl_in[<span class="number">0</span>].gl_Position;</span><br><span class="line">    gl_Position = ProjectionMatrix * (gl_in[<span class="number">0</span>].gl_Position + vec4(</span><br><span class="line">        -SIZE, SIZE, <span class="number">0.0</span>, <span class="number">0.0</span> ));</span><br><span class="line">    geom_texcoord = vec2( <span class="number">-1.0</span>, <span class="number">1.0</span> );</span><br><span class="line">    EmitVertex();</span><br><span class="line">    gl_Position = ProjectionMatrix * (gl_in[<span class="number">0</span>].gl_Position + vec4(</span><br><span class="line">        -SIZE, -SIZE, <span class="number">0.0</span>, <span class="number">0.0</span> ));</span><br><span class="line">    geom_texcoord = vec2( <span class="number">-1.0</span>, <span class="number">-1.0</span> );</span><br><span class="line">    EmitVertex();</span><br><span class="line">    gl_Position = ProjectionMatrix * (gl_in[<span class="number">0</span>].gl_Position + vec4(</span><br><span class="line">        SIZE, SIZE, <span class="number">0.0</span>, <span class="number">0.0</span> ));</span><br><span class="line">    geom_texcoord = vec2( <span class="number">1.0</span>, <span class="number">1.0</span> );</span><br><span class="line">    EmitVertex();</span><br><span class="line">    gl_Position = ProjectionMatrix * (gl_in[<span class="number">0</span>].gl_Position + vec4(</span><br><span class="line">        SIZE, -SIZE, <span class="number">0.0</span>, <span class="number">0.0</span> ));</span><br><span class="line">    geom_texcoord = vec2( <span class="number">1.0</span>, <span class="number">-1.0</span> );</span><br><span class="line">    EmitVertex();</span><br><span class="line">    EndPrimitive();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Drawing-particles-using-compute-and-graphics-pipelines"><a href="#Drawing-particles-using-compute-and-graphics-pipelines" class="headerlink" title="Drawing particles using compute and graphics pipelines"></a>Drawing particles using compute and graphics pipelines</h2><p>…</p>
<h2 id="Rendering-a-tessellated-terrain"><a href="#Rendering-a-tessellated-terrain" class="headerlink" title="Rendering a tessellated terrain"></a>Rendering a tessellated terrain</h2><p>vertex</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec4 app_position;</span><br><span class="line">layout( location = <span class="number">1</span> ) in vec2 app_texcoord;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec2 vert_texcoord;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    gl_Position = app_position;</span><br><span class="line">    vert_texcoord = app_texcoord;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>tessellation control</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec2 vert_texcoord[];</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">0</span> ) uniform UniformBuffer &#123;</span><br><span class="line">    mat4 ModelViewMatrix;</span><br><span class="line">    mat4 ProjectionMatrix;</span><br><span class="line">&#125;;</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">1</span> ) uniform sampler2D ImageSampler;</span><br><span class="line">layout( vertices = <span class="number">3</span> ) out;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec2 tesc_texcoord[];</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>( <span class="number">0</span> == gl_InvocationID ) &#123;</span><br><span class="line">        <span class="keyword">float</span> distances[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">float</span> factors[<span class="number">3</span>];</span><br><span class="line">        <span class="keyword">for</span>( <span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; ++i ) &#123;</span><br><span class="line">            <span class="keyword">float</span> height = texture( ImageSampler, vert_texcoord[i]</span><br><span class="line">                                  ).x;</span><br><span class="line">            vec4 position = ModelViewMatrix * (gl_in[i].gl_Position +</span><br><span class="line">                                               vec4( <span class="number">0.0</span>, height, <span class="number">0.0</span>, <span class="number">0.0</span> ));</span><br><span class="line">            distances[i] = dot( position, position );</span><br><span class="line">        &#125;</span><br><span class="line">        factors[<span class="number">0</span>] = min( distances[<span class="number">1</span>], distances[<span class="number">2</span>] );</span><br><span class="line">        factors[<span class="number">1</span>] = min( distances[<span class="number">2</span>], distances[<span class="number">0</span>] );</span><br><span class="line">        factors[<span class="number">2</span>] = min( distances[<span class="number">0</span>], distances[<span class="number">1</span>] );</span><br><span class="line">        gl_TessLevelInner[<span class="number">0</span>] = max( <span class="number">1.0</span>, <span class="number">20.0</span> - factors[<span class="number">0</span>] );</span><br><span class="line">        gl_TessLevelOuter[<span class="number">0</span>] = max( <span class="number">1.0</span>, <span class="number">20.0</span> - factors[<span class="number">0</span>] );</span><br><span class="line">        gl_TessLevelOuter[<span class="number">1</span>] = max( <span class="number">1.0</span>, <span class="number">20.0</span> - factors[<span class="number">1</span>] );</span><br><span class="line">        gl_TessLevelOuter[<span class="number">2</span>] = max( <span class="number">1.0</span>, <span class="number">20.0</span> - factors[<span class="number">2</span>] );</span><br><span class="line">    &#125;</span><br><span class="line">    gl_out[gl_InvocationID].gl_Position =</span><br><span class="line">        gl_in[gl_InvocationID].gl_Position;</span><br><span class="line">    tesc_texcoord[gl_InvocationID] =</span><br><span class="line">        vert_texcoord[gl_InvocationID];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>tessellation evaluation shader</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( triangles, fractional_even_spacing, cw ) in;</span><br><span class="line">layout( location = <span class="number">0</span> ) in vec2 tesc_texcoord[];</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">1</span> ) uniform sampler2D HeightMap;</span><br><span class="line">layout( location = <span class="number">0</span> ) out <span class="keyword">float</span> tese_height;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vec4 position = gl_in[<span class="number">0</span>].gl_Position * gl_TessCoord.x +</span><br><span class="line">        gl_in[<span class="number">1</span>].gl_Position * gl_TessCoord.y +</span><br><span class="line">        gl_in[<span class="number">2</span>].gl_Position * gl_TessCoord.z;</span><br><span class="line">    vec2 texcoord = tesc_texcoord[<span class="number">0</span>] * gl_TessCoord.x +</span><br><span class="line">        tesc_texcoord[<span class="number">1</span>] * gl_TessCoord.y +</span><br><span class="line">        tesc_texcoord[<span class="number">2</span>] * gl_TessCoord.z;</span><br><span class="line">    <span class="keyword">float</span> height = texture( HeightMap, texcoord ).x;</span><br><span class="line">    position.y += height;</span><br><span class="line">    gl_Position = position;</span><br><span class="line">    tese_height = height;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>geometry shader</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( triangles ) in;</span><br><span class="line">layout( location = <span class="number">0</span> ) in <span class="keyword">float</span> tese_height[];</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">0</span> ) uniform UniformBuffer &#123;</span><br><span class="line">    mat4 ModelViewMatrix;</span><br><span class="line">    mat4 ProjectionMatrix;</span><br><span class="line">&#125;;</span><br><span class="line">layout( triangle_strip, max_vertices = <span class="number">3</span> ) out;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec3 geom_normal;</span><br><span class="line">layout( location = <span class="number">1</span> ) out <span class="keyword">float</span> geom_height;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vec3 v0v1 = gl_in[<span class="number">1</span>].gl_Position.xyz -</span><br><span class="line">        gl_in[<span class="number">0</span>].gl_Position.xyz;</span><br><span class="line">    vec3 v0v2 = gl_in[<span class="number">2</span>].gl_Position.xyz -</span><br><span class="line">        gl_in[<span class="number">0</span>].gl_Position.xyz;</span><br><span class="line">    vec3 normal = normalize( cross( v0v1, v0v2 ) );</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> vertex = <span class="number">0</span>; vertex &lt; <span class="number">3</span>; ++vertex ) &#123;</span><br><span class="line">        gl_Position = ProjectionMatrix * ModelViewMatrix *</span><br><span class="line">            gl_in[vertex].gl_Position;</span><br><span class="line">        geom_height = tese_height[vertex];</span><br><span class="line">        geom_normal = normal;</span><br><span class="line">        EmitVertex();</span><br><span class="line">    &#125;</span><br><span class="line">    EndPrimitive();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>fragment</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec3 geom_normal;</span><br><span class="line">layout( location = <span class="number">1</span> ) in <span class="keyword">float</span> geom_height;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec4 frag_color;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> vec4 green = vec4( <span class="number">0.2</span>, <span class="number">0.5</span>, <span class="number">0.1</span>, <span class="number">1.0</span> );</span><br><span class="line">    <span class="keyword">const</span> vec4 brown = vec4( <span class="number">0.6</span>, <span class="number">0.5</span>, <span class="number">0.3</span>, <span class="number">1.0</span> );</span><br><span class="line">    <span class="keyword">const</span> vec4 white = vec4( <span class="number">1.0</span> );</span><br><span class="line">    vec4 color = mix( green, brown, smoothstep( <span class="number">0.0</span>, <span class="number">0.4</span>,</span><br><span class="line">                                               geom_height ) );</span><br><span class="line">    color = mix( color, white, smoothstep( <span class="number">0.6</span>, <span class="number">0.9</span>, geom_height )</span><br><span class="line">               );</span><br><span class="line">    <span class="keyword">float</span> diffuse_light = max( <span class="number">0.0</span>, dot( geom_normal, vec3( <span class="number">0.58</span>,</span><br><span class="line">                                                           <span class="number">0.58</span>, <span class="number">0.58</span> ) ) );</span><br><span class="line">    frag_color = vec4( <span class="number">0.05</span>, <span class="number">0.05</span>, <span class="number">0.0</span>, <span class="number">0.0</span> ) + diffuse_light *</span><br><span class="line">        color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="full-screen"><a href="#full-screen" class="headerlink" title="full screen"></a>full screen</h2><h2 id="input-attachments-for-color-correction-post-process-effect"><a href="#input-attachments-for-color-correction-post-process-effect" class="headerlink" title="input attachments for color correction post-process effect"></a>input attachments for color correction post-process effect</h2>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/1.2.Device/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nolife">
      <meta itemprop="description" content="一个游戏程序员的blog">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stoner">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/05/sdk/graphics/vulkan/1.2.Device/" class="post-title-link" itemprop="url">Device</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-05 21:16:00 / Modified: 21:18:57" itemprop="dateCreated datePublished" datetime="2019-04-05T21:16:00+08:00">2019-04-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/" itemprop="url" rel="index"><span itemprop="name">sdk</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/vulkan/" itemprop="url" rel="index"><span itemprop="name">vulkan</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><p>在创建了Vulkan Instance 对象后，下一步就是枚举physical devices,选择其中一个,并根据它创建又给logical device,这些操作通过instance-level级函数进行执行.</p>
<p>Vulkan里几乎所有工作都是在logical device上执行的：在其上创建资源，管理他们的内存，记录由它们创建的command buffers,向他们的queues提交处理commands.</p>
<h2 id="physical-device"><a href="#physical-device" class="headerlink" title="physical device"></a>physical device</h2><h3 id="枚举所有可以使用的physical-devices"><a href="#枚举所有可以使用的physical-devices" class="headerlink" title="枚举所有可以使用的physical devices"></a>枚举所有可以使用的physical devices</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> devices_count = <span class="number">0</span>;</span><br><span class="line">vkEnumeratePhysicalDevices( instance, &amp;devices_count,</span><br><span class="line"><span class="literal">nullptr</span> ).</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;VkPhysicalDevice&gt; available_devices(devices_count);</span><br><span class="line">vkEnumeratePhysicalDevices( instance, &amp;devices_count,</span><br><span class="line">&amp;available_devices[<span class="number">0</span>]).</span><br></pre></td></tr></table></figure>
<h3 id="extensions"><a href="#extensions" class="headerlink" title="extensions"></a>extensions</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">uint32_t extensions_count = 0;</span><br><span class="line">vkEnumerateDeviceExtensionProperties(physical_device,nullptr,&amp;extensions_count,nullptr);</span><br><span class="line">std::vector&lt;VkExtensionProperties&gt; available_extensions(extensions_count);</span><br><span class="line">vkEnumerateDeviceExtensionProperties(physical_device,nullptr,&amp;extensions_count,&amp;available_extensions[0]);</span><br></pre></td></tr></table></figure>
<h3 id="获取pyhsical-device的features和properties"><a href="#获取pyhsical-device的features和properties" class="headerlink" title="获取pyhsical device的features和properties"></a>获取pyhsical device的features和properties</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vkEnumeratePhysicalDevices()</span><br><span class="line">VkPhysicalDeviceFeatures device_features;//支持的特性,支持的shader类型(是否支持geometry,tessellation),depth clamp 和 bias,multiple viewports,或者wide lines.</span><br><span class="line">VkPhysicalDeviceProperties device_properties;//物理设备的属性,名字,驱动版本,api支持版本,设备类型(可能是CPU),limits(texture大小,buffer数量)</span><br><span class="line">vkGetPhysicalDeviceFeatures(physical_device, &amp;device_features);</span><br><span class="line">vkGetPhysicalDeviceProperties(physical_device,&amp;device_properties);</span><br></pre></td></tr></table></figure>
<h2 id="logic-device"><a href="#logic-device" class="headerlink" title="logic device"></a>logic device</h2><h3 id="检查可用的queue-families和他们的properties"><a href="#检查可用的queue-families和他们的properties" class="headerlink" title="检查可用的queue families和他们的properties"></a>检查可用的queue families和他们的properties</h3><p>在vulkan里,对硬件的所有操作都是通过提交到queues里进行的.提交到同一个queue里的命令是一个接着一个执行的,提交到不同queue里的命令是独立的(需要同步他们)</p>
<p><img src="media/queue.png" alt></p>
<p>不同的queues可能表示硬件的不同部分,因此会支持不同的操作,并非所有操作都可以在所有queue上执行.</p>
<p>有相同策略的queue被聚合在同样的family里,一个device可能暴露任意数量的queue families，每一个family可能包括一个或多个queues.要想检查硬件能执行什么操作,需要便利所有queue families的属性.</p>
<p>步骤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">uint32_t queue_families_count = 0;</span><br><span class="line">vkGetPhysicalDeviceQueueFamilyProperties( physical_device,</span><br><span class="line">&amp;queue_families_count, nullptr ).</span><br><span class="line">std::vector&lt;VkQueueFamilyProperties&gt; queue_families(queue_families_count);</span><br><span class="line">vkGetPhysicalDeviceQueueFamilyProperties(physical_device,</span><br><span class="line">&amp;queue_families_count, &amp;queue_families[0]);</span><br></pre></td></tr></table></figure>
<p>从properties中能获取到的最重要的信息是能在已给family的queues里进行的操作类型,操作类型被分为:</p>
<blockquote>
<ul>
<li>Graphics:创建graphics pipelines和drawing</li>
<li>Compute:创建compute pipelines和dispatching compute shaders</li>
<li>Transfer:用于非常快速的memory-copying操作</li>
<li>Sparse:允许附加的内存管理功能</li>
</ul>
</blockquote>
<p>family的queues可能支持不知一种操作,可能不同的queue families支持相同类型的操作.</p>
<p>family属性也告知了queues的数量,是否支持时间戳,图像传输操作的粒度(在copy/blit操作时能控制的图像的最小部分).</p>
<p>创建logic device需要的queue families数量,属性,每个family可用的queues数量准备好后,只在创建logical device时请求他们,需要制定需要多少queue以及来自哪些families，当创建好logic device后,对应的queue也自动被创建,我们只需要获得请求的queue的handles.</p>
<h3 id="重要属性-TODO"><a href="#重要属性-TODO" class="headerlink" title="重要属性 TODO"></a>重要属性 TODO</h3><h3 id="选择期望的queue-family"><a href="#选择期望的queue-family" class="headerlink" title="选择期望的queue family"></a>选择期望的queue family</h3><p>选择一个physical device</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">uint32_t queue_family_index = 0;</span><br><span class="line">VkQueueFlags desired_capabilities;//将期望的操作类型存储到该flag</span><br><span class="line">//VK_QUEUE_GRAPHICS_BIT,VK_QUEUE_COMPUTE_BIT,</span><br><span class="line">//VK_QUEUE_TRANSFER_BIT or VK_QUEUE_SPARSE_BINDING_BIT</span><br><span class="line">std::vector&lt;VkQueueFamilyProperties&gt; queue_families;</span><br><span class="line">//将上文获取到的结果存储到queue_families</span><br><span class="line">对queue_families所有元素进行判断</span><br><span class="line">	检查其queues数量是否&gt;0</span><br><span class="line">	检查desired_capabilities变量和queueFlags逻辑与操作不为0</span><br><span class="line">	如果二者都通过,则存储索引到queue_family_index并跳出循环</span><br><span class="line">重复上述操作知道所有元素被检查</span><br></pre></td></tr></table></figure>
<h3 id="创建logical-devcie"><a href="#创建logical-devcie" class="headerlink" title="创建logical devcie"></a>创建logical devcie</h3><p>logical device是app里创建的最重要的object,它代表了真实硬件,包括所有的扩展和激活的特性,以及向它请求的所有队列.</p>
<p><img src="media/logicdevice.png" alt></p>
<p>logical device允许我们做渲染软件里的所有工作，比如创建images和buffers，设置pipeline state或者加载shaders.最终要的是记录commands(比如draw calls或者分发computational works)和提交它们到queues.</p>
<h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">QueueInfo</span> &#123;</span></span><br><span class="line"><span class="keyword">uint32_t</span> FamilyIndex;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;<span class="keyword">float</span>&gt; Priorities;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;VkExtensionProperties&gt; available_extensions;</span><br><span class="line"><span class="keyword">if</span>( !CheckAvailableDeviceExtensions( physical_device, available_extensions</span><br><span class="line">) ) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span>( <span class="keyword">auto</span> &amp; extension : desired_extensions ) &#123;</span><br><span class="line">    <span class="keyword">if</span>( !IsExtensionSupported( available_extensions, extension ) ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Extension named '"</span> &lt;&lt; extension &lt;&lt; <span class="string">"' is not supported by</span></span><br><span class="line"><span class="string">    a physical device."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;VkDeviceQueueCreateInfo&gt; queue_create_infos;</span><br><span class="line"><span class="keyword">for</span>( <span class="keyword">auto</span> &amp; info : queue_infos ) &#123;</span><br><span class="line">queue_create_infos.push_back( &#123;</span><br><span class="line">VK_STRUCTURE_TYPE_DEVICE_QUEUE_CREATE_INFO,</span><br><span class="line"><span class="literal">nullptr</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">info.FamilyIndex,</span><br><span class="line"><span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(info.Priorities.size()),</span><br><span class="line">info.Priorities.size() &gt; <span class="number">0</span> ? &amp;info.Priorities[<span class="number">0</span>] : <span class="literal">nullptr</span></span><br><span class="line">&#125; );</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//Layers和extensions为非必需的</span></span><br><span class="line"><span class="comment">//但如果想使用高级特性(geometry,tessellation shaders)需要激活他们，</span></span><br><span class="line"><span class="comment">//不需要的特性可以关闭它们（有一些特性可能会影响性能）</span></span><br><span class="line">VkDeviceCreateInfo device_create_info = &#123;</span><br><span class="line">VK_STRUCTURE_TYPE_DEVICE_CREATE_INFO,</span><br><span class="line"><span class="literal">nullptr</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line"><span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(queue_create_infos.size()),</span><br><span class="line">queue_create_infos.size() &gt; <span class="number">0</span> ? &amp;queue_create_infos[<span class="number">0</span>] : <span class="literal">nullptr</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line"><span class="literal">nullptr</span>,</span><br><span class="line"><span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(desired_extensions.size()),</span><br><span class="line">desired_extensions.size() &gt; <span class="number">0</span> ? &amp;desired_extensions[<span class="number">0</span>] : <span class="literal">nullptr</span>,</span><br><span class="line">desired_features</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">vkCreateDevice( physical_device, &amp;device_create_info,</span><br><span class="line"><span class="literal">nullptr</span>, &amp;logical_device ).</span><br></pre></td></tr></table></figure>
<h3 id="获取device-queue"><a href="#获取device-queue" class="headerlink" title="获取device queue"></a>获取device queue</h3><p>device queue是硬件资源,只能获取已有数量的</p>
<p>前提</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">获取到VkDvice logical_dvice</span><br><span class="line">选取了queueFamilyIndx</span><br><span class="line">选择一个queue_indexx</span><br><span class="line">准备变量VkQueue queue</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">调用</span><br><span class="line">vkGetDeviceQueue(logical_device, queue_family_index,</span><br><span class="line">queue_index, &amp;queue);</span><br></pre></td></tr></table></figure>
<p>重复上述操作可以获取到所有queue families里的所有queues</p>
<h3 id="创建有geometry-shaders-graphics和compute-queues的logical-device"><a href="#创建有geometry-shaders-graphics和compute-queues的logical-device" class="headerlink" title="创建有geometry shaders,graphics和compute queues的logical device"></a>创建有geometry shaders,graphics和compute queues的logical device</h3><p>现在现需要美剧所有physical device找到其中支持geometry shaders,graphics和compute queues的来创建logical device</p>
<p>前期准备</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">声明变量</span><br><span class="line">VkDevice logical_device;</span><br><span class="line">VkQueue graphics_queue;</span><br><span class="line">VkQueue compute_queue;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;VkPhysicalDevice&gt; physical_devices;</span><br><span class="line">EnumerateAvailablePhysicalDevices( instance, physical_devices );</span><br></pre></td></tr></table></figure>
<p>对每一个physical device进行如下操作</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>( <span class="keyword">auto</span> &amp; physical_device : physical_devices ) &#123;</span><br><span class="line">    VkPhysicalDeviceFeatures device_features;</span><br><span class="line">    VkPhysicalDeviceProperties device_properties;</span><br><span class="line">    GetTheFeaturesAndPropertiesOfAPhysicalDevice( physical_device,</span><br><span class="line">                                                 device_features, device_properties );</span><br><span class="line">    <span class="comment">//geometry shader</span></span><br><span class="line">    <span class="keyword">if</span>( !device_features.geometryShader ) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        device_features = &#123;&#125;;</span><br><span class="line">        device_features.geometryShader = VK_TRUE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//graphic queue</span></span><br><span class="line">    <span class="keyword">uint32_t</span> graphics_queue_family_index;</span><br><span class="line">    <span class="keyword">if</span>( !SelectIndexOfQueueFamilyWithDesiredCapabilities( physical_device,</span><br><span class="line">                                                         VK_QUEUE_GRAPHICS_BIT, graphics_queue_family_index ) ) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//compute queue</span></span><br><span class="line">    <span class="keyword">uint32_t</span> compute_queue_family_index;</span><br><span class="line">    <span class="keyword">if</span>( !SelectIndexOfQueueFamilyWithDesiredCapabilities( physical_device,</span><br><span class="line">                                                         VK_QUEUE_COMPUTE_BIT, compute_queue_family_index ) ) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">vector</span>&lt;QueueInfo&gt; requested_queues = &#123; &#123;</span><br><span class="line">        graphics_queue_family_index, &#123; <span class="number">1.0f</span> &#125; &#125; &#125;;</span><br><span class="line">    <span class="keyword">if</span>( graphics_queue_family_index != compute_queue_family_index ) &#123;</span><br><span class="line">        requested_queues.push_back( &#123; compute_queue_family_index, &#123; <span class="number">1.0f</span> &#125; &#125; );</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>如果graphics和computee queue families有相同的index,我们能使用同一个queue,如果不同就要用两个</p>
<p>创建logical device</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( !CreateLogicalDevice( physical_device, requested_queues, &#123;&#125;,</span><br><span class="line">                         &amp;device_features, logical_device ) ) &#123;</span><br><span class="line">    <span class="keyword">continue</span>;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>( !LoadDeviceLevelFunctions( logical_device, &#123;&#125; ) ) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    GetDeviceQueue( logical_device, graphics_queue_family_index, <span class="number">0</span>,</span><br><span class="line">                   graphics_queue );</span><br><span class="line">    GetDeviceQueue( logical_device, compute_queue_family_index, <span class="number">0</span>,</span><br><span class="line">                   compute_queue );</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<h3 id="Destroying-a-logical-device"><a href="#Destroying-a-logical-device" class="headerlink" title="Destroying a logical device"></a>Destroying a logical device</h3><p>按照创建的相反顺序销毁资源</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( logical_device ) &#123;</span><br><span class="line">    vkDestroyDevice( logical_device, <span class="literal">nullptr</span> );</span><br><span class="line">    logical_device = VK_NULL_HANDLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/7.Shaders/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nolife">
      <meta itemprop="description" content="一个游戏程序员的blog">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stoner">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/05/sdk/graphics/vulkan/7.Shaders/" class="post-title-link" itemprop="url">Shaders</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-05 21:16:00 / Modified: 21:20:04" itemprop="dateCreated datePublished" datetime="2019-04-05T21:16:00+08:00">2019-04-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/" itemprop="url" rel="index"><span itemprop="name">sdk</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/vulkan/" itemprop="url" rel="index"><span itemprop="name">vulkan</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="Shaders"><a href="#Shaders" class="headerlink" title="Shaders"></a>Shaders</h1><p>[TOC]</p>
<h2 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h2><h3 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h3><blockquote>
<ul>
<li>Converting GLSL shaders to SPIR-V assemblies</li>
<li>Writing vertex shaders</li>
<li>Writing tessellation control shaders</li>
<li>Writing tessellation evaluation shaders</li>
<li>Writing geometry shaders</li>
<li>Writing fragment shaders</li>
<li>Writing compute shaders</li>
<li>Writing a vertex shader that multiplies a vertex position by a projection matrix</li>
<li>Using push constants in shaders</li>
<li>Writing a texturing vertex and fragment shaders</li>
<li>Displaying polygon normals with a geometry shader</li>
</ul>
</blockquote>
<h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>3D graphics data(vertices和fragments/pixels)运行在叫做stages的一些列步骤里.某些stages只执行固定操作(只能配置某些扩展操作).单有其他stages需要programmed.控制这些stages的行为的小programs称为shaders.</p>
<p>vulkan里最主要的5个可编程graphic pipeline stages为vertex,tessellation control,evaluation,geometry,fragment.(1.1.85发布了Raytracing, Mesh Shaders &amp; Other New NVIDIA Extensions，<a href="https://www.phoronix.com/scan.php?page=news_item&amp;px=Vulkan-1.1.85-Released).compute" target="_blank" rel="noopener">https://www.phoronix.com/scan.php?page=news_item&amp;px=Vulkan-1.1.85-Released).compute</a> pipeline有compute shader programs.core Vulkan API 通过SPIR-V的programs控制这些stages.他是一门中间语言,允许我们process graphics data和进行vectors,matrices,images,buffers,samplers的数学计算.这种语言的low-level特性提高了编译时间(compilation times).也使得书写shader困难.所以vulkan sdk提供一个工具链glslangValidator.</p>
<p>glslangValidator可以将GLSL转换为SPIR-V assemblies.</p>
<p>本文介绍GLSL,所有programmable stages的shaders实现,如何实现tessellation或texturing,如何使用geometry shaders来debuging.以及将GLSL转换为SPIR-V assemblies(使用glslangValidator).</p>
<h3 id="Converting-GLSL-shaders-to-SPIR-V-assemblies"><a href="#Converting-GLSL-shaders-to-SPIR-V-assemblies" class="headerlink" title="Converting GLSL shaders to SPIR-V assemblies"></a>Converting GLSL shaders to SPIR-V assemblies</h3><p>shaders与stage</p>
<blockquote>
<ul>
<li>vert for the vertex shader stage</li>
<li>tesc for the tessellation control shader stage</li>
<li>tese for the tessellation evaluation shader stage</li>
<li>geom for the geometry shader stage</li>
<li>frag for the fragment shader stage</li>
<li>comp for the compute shader</li>
</ul>
</blockquote>
<h3 id="Writing-vertex-shaders"><a href="#Writing-vertex-shaders" class="headerlink" title="Writing vertex shaders"></a>Writing vertex shaders</h3><p>顶点.</p>
<p>如果想绘制nosolid geometry,需要在创建logical device是激活fillModeNonSolid属性.</p>
<p>vertex processing是graphics pipeline第一个stage,主要目的是对顶点进行坐标转换,从局部坐标转换到coordinate system(clip space).这个clip coordinate system用于图形硬件后续步骤.其一为clipping.</p>
<p>但这个工作也可以延后到tessellation or geeometry shader.</p>
<p>存储到gl_Position.</p>
<p>一个例子</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line"><span class="keyword">layout</span>( <span class="keyword">location</span> = <span class="number">0</span> ) <span class="keyword">in</span> <span class="type">vec4</span> app_position;</span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">	<span class="built_in">gl_Position</span> = app_position;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Writing-tessellation-control-shaders"><a href="#Writing-tessellation-control-shaders" class="headerlink" title="Writing tessellation control shaders"></a>Writing tessellation control shaders</h3><p>细分.</p>
<p>需要在创建logical device时激活tessellationShader特性.</p>
<p>可选的.分为三步,其中两步是可编程的.The first programmable tessellation stage is used to set up parameters that control how the tessellation is performed.通过编写tessellation control shaders指明tessellation factors的值.</p>
<p>tessellation control and tessellation evaluation shaders是一起用的.</p>
<p>tessellation stage对patches进行操作.Patches由vertices组成,但与传统polygons不同,$\color {red}{每个patch可能任意个顶点,1~(至少)32个}​$.</p>
<p>细分是通过在shader代码里指明的inner和outer tessellation factors实现的.inner fctor由内置gl_TessLevelInner[]数组指明patch内部是如何细分的.outer factor 对应的是gl_TessLevelOuter[],定义了如何细分patches的外边缘(outer edges).每个数组元素对应于patches的给定边.</p>
<p>tessellation control shader对patch的每个vertex执行一次.当前vertex的index为gl_InvocationID.只有当前的可写,但可以通过gl_in[].gl_Position读取input patch的所有vertices.</p>
<p>一个例子</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line"><span class="keyword">layout</span>( <span class="keyword">vertices</span> = <span class="number">3</span> ) <span class="keyword">out</span>;</span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">    <span class="keyword">if</span>( <span class="number">0</span> == <span class="built_in">gl_InvocationID</span> ) &#123;</span><br><span class="line">        <span class="built_in">gl_TessLevelInner</span>[<span class="number">0</span>] = <span class="number">3.0</span>;</span><br><span class="line">        <span class="built_in">gl_TessLevelOuter</span>[<span class="number">0</span>] = <span class="number">3.0</span>;</span><br><span class="line">        <span class="built_in">gl_TessLevelOuter</span>[<span class="number">1</span>] = <span class="number">4.0</span>;</span><br><span class="line">        <span class="built_in">gl_TessLevelOuter</span>[<span class="number">2</span>] = <span class="number">5.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	<span class="built_in">gl_out</span>[<span class="built_in">gl_InvocationID</span>].<span class="built_in">gl_Position</span> = <span class="built_in">gl_in</span>[<span class="built_in">gl_InvocationID</span>].<span class="built_in">gl_Position</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="media/tessellation1.png" alt></p>
<h3 id="Writing-tessellation-evaluation-shaders"><a href="#Writing-tessellation-evaluation-shaders" class="headerlink" title="Writing tessellation evaluation shaders"></a>Writing tessellation evaluation shaders</h3><p>Tessellation evaluations是tessellation process的第二个可编程stage.当geometry被细分后(subdivided),手机细分的结果形成新的vertices并重新修改它们.我们需要编写tessellation evaluation shaders来获取生成的顶点的位置,并将它们提供给连续的consecutive pipeline stages.</p>
<p>在这两个着色器之间是根据control stage 提供的参数进行细分的真实过程.tessellation的结果在evaluation stage中用到,生成新的geometry.</p>
<p>在tessellation evaluation中能控制新的primitives如何对其并形成.我们指定了它们的缠绕顺序(winding order)和生成顶点之间的间距.同时能选择是否在tessellation stage创建isolines, triangles,or quads来改变图元类型.</p>
<p>新顶点㐊直接创建的,细分器只为新vertices生成重心细分坐标(barycentric tessellation coordinates)(weights),内置变量为gl_TessCoord.我们可以使用这些坐标在形成面片的顶点的原始位置之间进行插值(interpolate),并将新的顶点放置在正确的位置.这也是evaluation shader可以访问所有顶点的原因.(gl_in[].gl_Position)</p>
<p>三角形通常不用做任何事</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( triangles, equal_spacing, cw ) in;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    gl_Position = gl_in[<span class="number">0</span>].gl_Position * gl_TessCoord.x +</span><br><span class="line">    gl_in[<span class="number">1</span>].gl_Position * gl_TessCoord.y +</span><br><span class="line">    gl_in[<span class="number">2</span>].gl_Position * gl_TessCoord.z;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Writing-geometry-shaders"><a href="#Writing-geometry-shaders" class="headerlink" title="Writing geometry shaders"></a>Writing geometry shaders</h3><p>当绘制Object时,我们提供顶点并指明图元(primitives)类型(points,lines,triangles).在vertex和可选的tessellation stages后,形成了指定的图元类型.可选的可以激活geometry stage并写geometry shaders控制或改变从vertices形成primitives的过程.在geometry shaders甚至可以创建新的primities或销毁已经存在的.</p>
<p>geometry shaders允许创建额外的vertices混合primitives,删除已经存在的或改变vertices形成的primitive类型.</p>
<p>它能访问primitvie的所有vertices,且能调整它们.根据这些数据能原文传递或者创建新的vertices和primitives.但不能在一个gs中创建太多vetices.tessellation shaders更适合做这种操作.应尽量减少gs发出的顶点数.</p>
<p>gs总生成strip primitives.如果想创建独立图元–不形成strip,只需要在合适的时机end a primitive–vertices emitted</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( triangles ) in;</span><br><span class="line">layout( triangle_strip, max_vertices = <span class="number">9</span> ) out;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> vertex = <span class="number">0</span>; vertex &lt; <span class="number">3</span>; ++vertex ) &#123;</span><br><span class="line">        gl_Position = gl_in[vertex].gl_Position + vec4( <span class="number">0.0</span>, <span class="number">-0.2</span>, <span class="number">0.0</span>, <span class="number">0.0</span> );</span><br><span class="line">        EmitVertex();</span><br><span class="line">        gl_Position = gl_in[vertex].gl_Position + vec4( <span class="number">-0.2</span>, <span class="number">0.2</span>, <span class="number">0.0</span>, <span class="number">0.0</span> );</span><br><span class="line">        EmitVertex();</span><br><span class="line">        gl_Position = gl_in[vertex].gl_Position + vec4( <span class="number">0.2</span>, <span class="number">0.2</span>, <span class="number">0.0</span>, <span class="number">0.0</span> );</span><br><span class="line">        EmitVertex();</span><br><span class="line">        EndPrimitive();<span class="comment">//介绍一个图元,不形成strip</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="media/geometryshader1.png" alt></p>
<h3 id="Writing-fragment-shaders"><a href="#Writing-fragment-shaders" class="headerlink" title="Writing fragment shaders"></a>Writing fragment shaders</h3><p>fragment对geometry shader后的操作(rasterization,光栅化)的数据进行计算,一般使用屏幕坐标系(screen space coordinate(x,y,depth)).能选择哪个attachment写入颜色.</p>
<p>geometry 形成的primitives在rasterization过程中转换为fragments(pixels).fragment sahder对每个fragment执行一遍.shader中或framebuffer tests(depth,stencil,scissor tests)中Fragments可能discard,不会成为pixels–这是它们称为fragments而不是pixels的原因.</p>
<p>fragment sahder最重要的目的是设置写入attachement的颜色.通常进行光照计算和texturing.和compute shaders配合,fragment shader还常用来进行后处理(bloom等)或者defered shading/lighting.同时,只有fragment shader能访问render  pass定义的input attachments.</p>
<p>一个简单例子</p>
<figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line"><span class="keyword">layout</span>( <span class="keyword">location</span> = <span class="number">0</span> ) <span class="keyword">out</span> <span class="type">vec4</span> frag_color;</span><br><span class="line"><span class="type">void</span> main() &#123;</span><br><span class="line">	frag_color = <span class="type">vec4</span>( <span class="number">0.8</span>, <span class="number">0.4</span>, <span class="number">0.0</span>, <span class="number">1.0</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Writing-compute-shaders"><a href="#Writing-compute-shaders" class="headerlink" title="Writing compute shaders"></a>Writing compute shaders</h3><p>compute shader常用来数学计算.它们以3D形式的组执行并可能访问a common set of data.同时,很多local groups能一起执行能更快得到结果.</p>
<p>只能在compute pipeline里使用.</p>
<p>compute shadeers没有任何早于或晚于pipeline stages的输入或输出.只有compute pipeline stage的.uniform varables必须作为其数据来源.相似,计算结果存储在Uniform variables.</p>
<p>有些内置变量.用来索引.</p>
<p>local workgroup中给定compute shader调用的索引</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uvec3 gl_LocalInvocationID</span><br></pre></td></tr></table></figure>
<p>同时分发的workgroups的数量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uvec3 gl_NumWorkGroups</span><br></pre></td></tr></table></figure>
<p>当前workgroup的number</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uvec3 gl_WorkGroupID</span><br></pre></td></tr></table></figure>
<p>还有个给当前shader在所有workgroups里所有调用唯一编号的</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">uvec3 gl_GlobalInvocationID;</span><br><span class="line">= gl_WorkGroupID * gl_WorkGroupSize + gl_LocalInvocationID</span><br></pre></td></tr></table></figure>
<p>local workgroup的size由input layout qualifier定义.在shader里,uvec3 gl_WorkGroupSize也可以获得这个size.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( local_size_x = <span class="number">32</span>, local_size_y = <span class="number">32</span> ) in;</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">0</span>, rgba8 ) uniform image2D StorageImage;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    vec2 z = gl_GlobalInvocationID.xy * <span class="number">0.001</span> - vec2( <span class="number">0.0</span>, <span class="number">0.4</span> );</span><br><span class="line">    vec2 c = z;</span><br><span class="line">    vec4 color = vec4( <span class="number">0.0</span> );</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">50</span>; ++I ) &#123;</span><br><span class="line">        z.x = z.x * z.x-- z.y * z.y + c.x;</span><br><span class="line">        z.y = <span class="number">2.0</span> * z.x * z.y + c.y;</span><br><span class="line">        <span class="keyword">if</span>( dot( z, z ) &gt; <span class="number">10.0</span> ) &#123;</span><br><span class="line">        color = i * vec4( <span class="number">0.1</span>, <span class="number">0.15</span>, <span class="number">0.2</span>, <span class="number">0.0</span> );</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	imageStore( StorageImage, ivec2( gl_GlobalInvocationID.xy ), color );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="media/computeshader1.png" alt></p>
<h3 id="Writing-a-vertex-shader-that-multiplies-vertex-position-by-a-projection-matrix"><a href="#Writing-a-vertex-shader-that-multiplies-vertex-position-by-a-projection-matrix" class="headerlink" title="Writing a vertex shader that multiplies vertex position by a projection matrix"></a>Writing a vertex shader that multiplies vertex position by a projection matrix</h3><p>将geometry从local 变换到clip space通常在vertex shader进行,尽管其他vertex processing stage(tessellation or geometry)也能完成这个工作.这个变换通过指明model,view,projection matrices和从app提供三者的值给shader或者合为一个MVP矩阵.最普通和简单的方式是使用uniform buffer.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout(location = <span class="number">0</span>) in vec4 app_position;</span><br><span class="line">layout(<span class="built_in">set</span>=<span class="number">0</span>, binding=<span class="number">0</span>) uniform UniformBuffer &#123;</span><br><span class="line">	mat4 ModelViewProjectionMatrix;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	gl_Position = ModelViewProjectionMatrix * app_position;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>uniform buffer $0^{th}$ set,$0^{th}$ binding.</p>
<h3 id="using-push-constants-in-shaders"><a href="#using-push-constants-in-shaders" class="headerlink" title="using push constants in shaders"></a>using push constants in shaders</h3><p>当给shaders提供数据通常使用uniform buffers,storage buffers,或其他descriptor resources.不幸的是更新这样一个 resources可能不太合适,尤其是经常改变数据的时候.</p>
<p>为了这个目的,需要引入push constants.通过它们我们能用更简单和快速的方法提供数据.单需要fit更小的可用空间.</p>
<p>使用GLSL shaders里的push constants类似uniform buffers.</p>
<p>不同之处</p>
<blockquote>
<ul>
<li>1.使用layout(push_constant)</li>
<li>必须指明instance name</li>
<li>每个shader只能定义一个</li>
<li>通过访问instance name of the block 访问push constant</li>
</ul>
</blockquote>
<p>constants在更新频繁的小数据上非常游泳,比如变换矩阵或物理量(time,dt等).需要记住数据的size比descriptor resources小得多.$\color{red}{规范要求push constants至少存储128 bytes数据}$.每个硬件平台可能允许更多的存储,但可能不会大得多.</p>
<p>在提供颜色的片段明暗器中定义和使用push常量的示例如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#version 450</span><br><span class="line">layout( location = 0 ) out vec4 frag_color;</span><br><span class="line">layout( push_constant ) uniform ColorBlock &#123;</span><br><span class="line">	vec4 Color;</span><br><span class="line">&#125; PushConstant;</span><br><span class="line">void main() &#123;</span><br><span class="line">	frag_color = PushConstant.Color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Writing-texturing-vertex-and-fragment-shaders"><a href="#Writing-texturing-vertex-and-fragment-shaders" class="headerlink" title="Writing texturing vertex and fragment shaders"></a>Writing texturing vertex and fragment shaders</h3><p>vertex shader</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec4 app_position;</span><br><span class="line">layout( location = <span class="number">1</span> ) in vec2 app_tex_coordinates;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec2 vert_tex_coordinates;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    gl_Position = app_position;</span><br><span class="line">    vert_tex_coordinates = app_tex_coordinates;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>fragment shader</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec2 vert_tex_coordinates;</span><br><span class="line">layout( <span class="built_in">set</span>=<span class="number">0</span>, binding=<span class="number">0</span> ) uniform sampler2D TextureImage;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec4 frag_color;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	frag_color = texture( TextureImage, vert_tex_coordinates );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Displaying-polygon-normals-with-a-geometry-shader"><a href="#Displaying-polygon-normals-with-a-geometry-shader" class="headerlink" title="Displaying polygon normals with a geometry shader"></a>Displaying polygon normals with a geometry shader</h3><p>介绍一种简单的检查发现的方法.</p>
<p>vertex shader</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec4 app_position;</span><br><span class="line">layout( location = <span class="number">1</span> ) in vec3 app_normal;</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">0</span> ) uniform UniformBuffer &#123;</span><br><span class="line">    mat4 ModelViewMatrix;</span><br><span class="line">    mat4 ProjectionMatrix;</span><br><span class="line">&#125;;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec4 vert_normal;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    gl_Position = ModelViewMatrix * app_position;</span><br><span class="line">    vert_normal = vec4( mat3( ModelViewMatrix ) * app_normal * <span class="number">0.2</span>, <span class="number">0.0</span> );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>view space</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( triangles ) in;</span><br><span class="line">layout( location = <span class="number">0</span> ) in vec4 vert_normal[];</span><br><span class="line">layout( <span class="built_in">set</span> = <span class="number">0</span>, binding = <span class="number">0</span> ) uniform UniformBuffer &#123;</span><br><span class="line">    mat4 ModelViewMatrix;</span><br><span class="line">    mat4 ProjectionMatrix;</span><br><span class="line">&#125;;</span><br><span class="line">layout( line_strip, max_vertices = <span class="number">6</span> ) out;<span class="comment">//line</span></span><br><span class="line">layout( location = <span class="number">0</span> ) out vec4 geom_color;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>( <span class="keyword">int</span> vertex = <span class="number">0</span>; vertex &lt; <span class="number">3</span>; ++vertex ) &#123;</span><br><span class="line">        gl_Position = ProjectionMatrix * gl_in[vertex].gl_Position;</span><br><span class="line">        geom_color = vec4( <span class="number">0.2</span> );</span><br><span class="line">        EmitVertex();</span><br><span class="line">        gl_Position = ProjectionMatrix * (gl_in[vertex].gl_Position +</span><br><span class="line">        vert_normal[vertex]);<span class="comment">//normal 方向延长，并变换到clip space</span></span><br><span class="line">        geom_color = vec4( <span class="number">0.6</span> );</span><br><span class="line">        EmitVertex();</span><br><span class="line">        EndPrimitive();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么使用一个uniform buffer呢？一般来说cb里步骤越少效率越高</p>
<p>fragment shader</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#version 450</span></span><br><span class="line">layout( location = <span class="number">0</span> ) in vec4 geom_color;</span><br><span class="line">layout( location = <span class="number">0</span> ) out vec4 frag_color;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	frag_color = geom_color;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/一手资料/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nolife">
      <meta itemprop="description" content="一个游戏程序员的blog">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stoner">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/05/sdk/graphics/vulkan/一手资料/" class="post-title-link" itemprop="url">一手资料</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-05 21:16:00 / Modified: 21:21:56" itemprop="dateCreated datePublished" datetime="2019-04-05T21:16:00+08:00">2019-04-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/" itemprop="url" rel="index"><span itemprop="name">sdk</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/vulkan/" itemprop="url" rel="index"><span itemprop="name">vulkan</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/vulkan/一手资料/" itemprop="url" rel="index"><span itemprop="name">一手资料</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<p><a href="https://vulkan.lunarg.com" target="_blank" rel="noopener">https://vulkan.lunarg.com</a></p>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/调试相关/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nolife">
      <meta itemprop="description" content="一个游戏程序员的blog">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stoner">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/05/sdk/graphics/vulkan/调试相关/" class="post-title-link" itemprop="url">关于调试</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-05 21:16:00 / Modified: 21:21:14" itemprop="dateCreated datePublished" datetime="2019-04-05T21:16:00+08:00">2019-04-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/" itemprop="url" rel="index"><span itemprop="name">sdk</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/vulkan/" itemprop="url" rel="index"><span itemprop="name">vulkan</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h2 id="validation-layers"><a href="#validation-layers" class="headerlink" title="validation layers"></a>validation layers</h2><p>由<a href="https://github.com/LunarG提供" target="_blank" rel="noopener">https://github.com/LunarG提供</a></p>
<p><a href="https://github.com/KhronosGroup/Vulkan-ValidationLayers" target="_blank" rel="noopener">https://github.com/KhronosGroup/Vulkan-ValidationLayers</a></p>
<h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>​    Vulkan API设计时时刻考虑着性能.其中一个提升其性能的方式是减少驱动的状态和错误检查.这是Vulkan被称为”thin API”或”thin driver”，因为它硬件的最小抽象–这在多个硬件上跨平台是必须的(高性能的PC,移动手机,低性能的嵌入式设备等).</p>
<p>​    这导致变现Vulkan API的app更困难.为了解决这个问题,Vulkan也被设计为一个分层的API,最底层和核心的曾是Vulkan API自己–与驱动交互.它的上策(app与Vulkan API之间),开发者可以激活额外的layers,简化debugging流程.</p>
<p><img src="media/validationlayers.png" alt></p>
<h3 id="如何做"><a href="#如何做" class="headerlink" title="如何做"></a>如何做</h3><h4 id="windows"><a href="#windows" class="headerlink" title="windows"></a>windows</h4><blockquote>
<ul>
<li><p>找到Vulkan SDK安装目录,找到./Config文件夹</p>
</li>
<li><p>将其内的vk_layer_settings.txt拷贝执行程序所在文件夹内</p>
</li>
<li><p>创建环境变量 VK_INSTANCE_LAYERS:</p>
<blockquote>
<p>打开控制台(cmd.exe),输入一下内容:</p>
<p>setx VK_INSTANCE_LAYERS</p>
<p>VK_LAYER_LUNARG_standard_validation</p>
</blockquote>
</li>
<li><p>重新打开控制台</p>
</li>
<li><p>使用控制台执行要测试的程序,warnings或errors会显示到控制台里</p>
</li>
</ul>
</blockquote>
<h4 id="linux类似"><a href="#linux类似" class="headerlink" title="linux类似"></a>linux类似</h4><blockquote>
<ul>
<li><p>同上</p>
</li>
<li><p>同上</p>
</li>
<li><p>输入命令变为</p>
<blockquote>
<p>export</p>
<p>VK_INSTANCE_LAYERS=VK_LAYER_LUNARG_standard_validation</p>
</blockquote>
</li>
<li><p>同上</p>
</li>
</ul>
</blockquote>
<h3 id="如何工作的"><a href="#如何工作的" class="headerlink" title="如何工作的"></a>如何工作的</h3><p>Vulkan validation layers包含了一组创建app时辅助找到潜在问题的库.他们的调试策略包括但不限于：参数检测,确认texture和RT的formats,追踪Vulkan objects的生命周期和使用,检查Vulkan API函数调用的潜在的内存泄漏和奔溃.这些功能通过激活不同的validation layers来启动,但其中大多数被集中到了一个叫VK_LAYER_LUNARG_standard_validation的层.其他layers包括:VK_LAYER_LUNARG_swapchain,VK_LAYER_LUNARG_object_tracker,VK_LAYER_GOOGLE_threading,VK_LAYER_LUNARG_api_dump等.多个layers可以同时激活,如果是windows这样做:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">setx VK_INSTANCE_LAYERS</span><br><span class="line">VK_LAYER_LUNARG_api_dump;VK_LAYER_LUNARG_core_validation</span><br></pre></td></tr></table></figure>
<p>如果是linux:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> VK_INSTANCE_LAYERS=VK_LAYER_LUNARG_api_dump:VK_LAYER_LUNARG_core_validation</span><br></pre></td></tr></table></figure>
<p>但是上述的方法都是全局的,事实上,实际编程时,我们根据是否时DEBUG模式动态决定是否使用Vulkan validation layers.</p>
<h3 id="实际编程的做法"><a href="#实际编程的做法" class="headerlink" title="实际编程的做法"></a>实际编程的做法</h3><p>通过标准宏NDEBUG决定是否启用某些validation layers</p>
<p>通过vkEnumerateInstanceLayerProperties获得支持的validation layers</p>
<p>将支持且需要启用的validation layer绑定到VkInstanceCreateInfo</p>
<p>调用vkCreateInstance时启用</p>
<p>定义调试回调函数,PFN_vkDebugReportCallbackEXT</p>
<p>填充结构VkDebugReportCallbackCreateInfoEXT</p>
<p>调用vkCreateDebugReportCallbackEXT(扩展函数,需要使用vkGetInstanceprocAddr获得)创建</p>
<p>注意需要在清理Instance前调用vkDestroyDebugReportCallbackEXT清理callback</p>
<p>参考<a href="https://blog.csdn.net/lbknxy/article/details/52430599" target="_blank" rel="noopener">https://blog.csdn.net/lbknxy/article/details/52430599</a></p>
<h2 id="其他调试技巧"><a href="#其他调试技巧" class="headerlink" title="其他调试技巧"></a>其他调试技巧</h2><h3 id="RenderDoc"><a href="#RenderDoc" class="headerlink" title="RenderDoc"></a>RenderDoc</h3>
          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/3.CommadnBuffersAndSynchronization/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nolife">
      <meta itemprop="description" content="一个游戏程序员的blog">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stoner">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/05/sdk/graphics/vulkan/3.CommadnBuffersAndSynchronization/" class="post-title-link" itemprop="url">Command Buffers and Synchronization</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-05 21:16:00 / Modified: 21:16:47" itemprop="dateCreated datePublished" datetime="2019-04-05T21:16:00+08:00">2019-04-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/" itemprop="url" rel="index"><span itemprop="name">sdk</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/vulkan/" itemprop="url" rel="index"><span itemprop="name">vulkan</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="Command-Buffers-and-Synchronization"><a href="#Command-Buffers-and-Synchronization" class="headerlink" title="Command Buffers and Synchronization"></a>Command Buffers and Synchronization</h1><p>[TOC]</p>
<h2 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h2><p>Creating a command pool<br>Allocating command buffers<br>Beginning a command buffer recording operation<br>Ending a command buffer recording operation<br>Resetting a command buffer<br>Resetting a command pool<br>Creating a semaphore<br>Creating a fence<br>Waiting for fences<br>Resetting fences<br>Submitting command buffers to a queue<br>Synchronizing two command buffers<br>Checking if processing of a submitted command buffer has finished<br>Waiting until all commands submitted to a queue are finished<br>Waiting for all submitted commands to be finished<br>Destroying a fence<br>Destroying a semaphore<br>Freeing command buffers<br>Destroying a command pool</p>
<p>Vulkan的low-level APIs给予了我们队硬件更多的控制权.包括对资源的创建、管理、操作，以及与硬件的交互.command buffer是最重要的object.它允许我们记录操作并提交给硬件执行.更重要的是能在多线程中记录他们,而且是由驱动隐形记录并不需要开发者控制它们.vulkan允许我们重复使用已经存在的command buffers.给予了便利的同时也让开发者有更多的责任.</p>
<p>为此需要格外小心命令的提交,尤其要处理提交command buffer到GPU时如何同步,为此引入了semaphores和fences.</p>
<p>本节讨论command buffers的allocate、record、submit,如何创建synchronizatin primitives并使用它们控制提交操作,如何同步GPU上的command buffers,如何同步app和硬件.</p>
<h2 id="command-pool"><a href="#command-pool" class="headerlink" title="command pool"></a>command pool</h2><h3 id="创建command-pool"><a href="#创建command-pool" class="headerlink" title="创建command pool"></a>创建command pool</h3><p>command pool是command buffer申请缓存的地方.缓存是隐性和动态创建的,但如果没有它command buffer就没地方记录commands了.所以先创建command pool</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">VkCommandPoolCreateInfo command_pool_create_info = &#123;</span><br><span class="line">    VK_STRUCTURE_TYPE_COMMAND_POOL_CREATE_INFO,</span><br><span class="line">    <span class="literal">nullptr</span>,</span><br><span class="line">    parameters,</span><br><span class="line">    queue_family</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>VK_COMMAND_POOL_CREATE_TRANSIENT_BIT 从pool里申请一个cb,存在非常短的时间.</p>
<p>VK_COMMAND_POOL_CREATE_RESET_COMMAND_BUFFER_BIT,能立即重置cb.如果没有这个flag,我们只能通过group进行操作(pool的cbs一起).如果没有这个flag,只能记录一次cb.如果想再次记录,需要重置整个pool.</p>
<p>command pools控制command buffers提交的队列.这二十用过queue family index实现,必须在创建Pool时提供.特定pool提供的cb只能提交给特定的family.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">VkResult result = vkCreateCommandPool( logical_device,</span><br><span class="line">&amp;command_pool_create_info, <span class="literal">nullptr</span>, &amp;command_pool );</span><br><span class="line"><span class="keyword">if</span>( VK_SUCCESS != result ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not create command pool."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>command pools在多线程里不能同时被访问.这就是为什么将在其上记录命令缓冲区的每个应用程序线程都应该使用单独的command pools的原因.</p>
<h2 id="command-buffer"><a href="#command-buffer" class="headerlink" title="command buffer"></a>command buffer</h2><h3 id="allocate-command-buffers"><a href="#allocate-command-buffers" class="headerlink" title="allocate command buffers"></a>allocate command buffers</h3><p>command buffers从command pools进行aloocate,这运行我们控制整个groups的一些属性.</p>
<blockquote>
<ul>
<li>只能提交到当创建command pool时选择的family的queue里.</li>
<li>command pools不能异步使用,所以需要为每个线程创建自己的command pools,减少同步消耗,提升性能</li>
</ul>
</blockquote>
<p>command buffers也有自己的属性,一些是记录操作时指定,但在allocate command buffer时有一些重要参数,是否想allocate主或次command buffers:</p>
<blockquote>
<ul>
<li>primary command buffers能直接提交到queues.也能执行(call)次command buffers.</li>
<li>次command buffers只能通过主command buffers执行.不能提交.</li>
</ul>
</blockquote>
<p>这些参数通过VkCommandBufferAllocateInfo指定</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">VkCommandBufferAllocateInfo command_buffer_allocate_info = &#123;</span><br><span class="line">    VK_STRUCTURE_TYPE_COMMAND_BUFFER_ALLOCATE_INFO,</span><br><span class="line">    <span class="literal">nullptr</span>,</span><br><span class="line">    command_pool,</span><br><span class="line">    level,</span><br><span class="line">    count</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>allocate</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">command_buffers.resize( count );</span><br><span class="line">VkResult result = vkAllocateCommandBuffers( logical_device,</span><br><span class="line">&amp;command_buffer_allocate_info, &amp;command_buffers[<span class="number">0</span>] );</span><br><span class="line"><span class="keyword">if</span>( VK_SUCCESS != result ) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not allocate command buffers."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h3 id="开始command-buffer-record操作"><a href="#开始command-buffer-record操作" class="headerlink" title="开始command buffer record操作"></a>开始command buffer record操作</h3><p>当想用硬件执行操作时,需要记录它们并提交给queue.命令记录在command buffers里.当我们记录它们时,我们需要选择一个command buffer.</p>
<p>vulkan里能做的最重要的事情就是记录command buffers了.也是告诉硬件做什么怎么做的唯一方式.当开始record command buffers时,它们的状态时无定义的.通常,command buffer不继承任何状态.当我们记录操作时,我们需要记住设置与这些操作相关的状态.比如drawing command,使用vertex attributes和indices.在我们记录一次drawing操作前,需要用顶点数据和索引数据绑定到各自适当的缓冲区.</p>
<p>主command buffers能call(执行)记录在次command buffers里的命令.执行次command buffers不继承主command buffers的状态.主command buffer的状态在执行次command buffer后也是未定义的(当我们record 一个主command buffer,并且执行了它的一个次command buffer后,我们如果想继续record主command buffer,需要重新设置状态).只有一个意外的state继承规则–当主command buffer在一个render pass里,我们执行一个它的次command buffer,主command buffer的render pass和subpass states被保持着.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">VkCommandBufferBeginInfo command_buffer_begin_info = &#123;</span><br><span class="line">    VK_STRUCTURE_TYPE_COMMAND_BUFFER_BEGIN_INFO,</span><br><span class="line">    <span class="literal">nullptr</span>,</span><br><span class="line">    usage,</span><br><span class="line">    secondary_command_buffer_info</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>为了性能考虑,需要避免command buffer使用下列标记</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">K_COMMAND_BUFFER_USAGE_SIMULTANEOUS_USE_BIT</span><br></pre></td></tr></table></figure>
<p>开始记录</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">VkResult result = vkBeginCommandBuffer( command_buffer,</span><br><span class="line">&amp;command_buffer_begin_info );</span><br><span class="line">if( VK_SUCCESS != result ) &#123;</span><br><span class="line">    std::cout &lt;&lt; &quot;Could not begin command buffer recording operation.&quot; &lt;&lt;</span><br><span class="line">    std::endl;</span><br><span class="line">    return false;</span><br><span class="line">&#125;</span><br><span class="line">return true;</span><br></pre></td></tr></table></figure>
<p>现在可以向command buffer选择操作了.但我们如何知道哪些操作可以记录到command buffer里.这类函数的名字以vkCmd开头,第一个参数全是VkCommandBuffer.但需要记住不是所有命令都能给主和次command buffers使用.</p>
<h3 id="结束command-buffer-recording-operation"><a href="#结束command-buffer-recording-operation" class="headerlink" title="结束command buffer recording operation"></a>结束command buffer recording operation</h3><p>当我们不想记录更多commands到command buffer,我们需要停止recording它.</p>
<p>为了更快记录和更小影响性能,记录commands时不会有任何报错,所有错误都在vkEndCommandBuffer函数汇报.</p>
<p>所以停止record时需要判断record是否成功</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">VkResult result = vkEndCommandBuffer( command_buffer );</span><br><span class="line"><span class="keyword">if</span>( VK_SUCCESS != result ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Error occurred during command buffer recording."</span> &lt;&lt;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>如果报错,就不能submit它,而需要重置它.</p>
<h3 id="重置command-buffer"><a href="#重置command-buffer" class="headerlink" title="重置command buffer"></a>重置command buffer</h3><p>如果一个command buffer报错了,必须reset才能重新record.可以通过开始另一个record操作来隐性重置它,也可以显示做到这点.</p>
<p>可以通过重置整个command pool来重置command buffers.也可以独立进行.只有在使用K_COMMAND_POOL_CREATE_RESET_COMMAND_BUFFER_BIT标志创建了用于分配命令缓冲区的池时,才能执行单独的重置.</p>
<p>显示重置让我们控制command buffer从创建它的pool里申请欢成.在显示重置时,我们能决定是否向归还缓存给pool,或者是否command buffer需要继续保留并在下次command record时复用它.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">VkResult result = vkResetCommandBuffer( command_buffer, release_resources ?</span><br><span class="line">VK_COMMAND_BUFFER_RESET_RELEASE_RESOURCES_BIT : <span class="number">0</span> );</span><br><span class="line">    <span class="keyword">if</span>( VK_SUCCESS != result ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Error occurred during command buffer reset."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h3 id="重置command-pool"><a href="#重置command-pool" class="headerlink" title="重置command pool"></a>重置command pool</h3><p>当我们不想单独重置command buffer或者如果我们创建的pool没有标记VK_COMMAND_POOL_CREATE_RESET_COMMAND_BUFFER_BIT,我们能一次重置pool的所有command buffer.</p>
<p>重置command pool会导致所有由它创建的command buffers回到初始状态.这和单独重置所有command buffers一样,但更快速.并且没有指定VK_COMMAND_POOL_CREATE_RESET_COMMAND_BUFFER_BIT标记.</p>
<p>当command buffers被record,它们从pool里得到缓存,这被自动执行.当重置command buffer时,可以选择是否command buffers保留它们的缓存以备后用,或者返回给pool.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">VkResult result = vkResetCommandPool( logical_device, command_pool,</span><br><span class="line">release_resources ? VK_COMMAND_POOL_RESET_RELEASE_RESOURCES_BIT : <span class="number">0</span> );</span><br><span class="line"><span class="keyword">if</span>( VK_SUCCESS != result ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Error occurred during command pool reset."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h2 id="semaphore-和-fence"><a href="#semaphore-和-fence" class="headerlink" title="semaphore 和 fence"></a>semaphore 和 fence</h2><h3 id="创建semaphore"><a href="#创建semaphore" class="headerlink" title="创建semaphore"></a>创建semaphore</h3><p>在提交commands和利用(utilize)设备的处理能力前,我们需要知道如何同步操作.semaphores时用于同步的原语(primitives).它们允许我们不仅在一个队列中而且在一个逻辑设备中的不同队列之间协调提交到队列的操作.</p>
<p>semaphores当我们提交commands给queus使用.所以在我们使用它们前需要创建.</p>
<p>semaphores由两个状态:signaled或者unsignaled.semaphores在command buffer提交时使用.我们将它们提供给一个要发出信号的信号量列表时,一旦给定批中提交的所有工作完成,它们就会将状态更改为signaled.相同方式,当我们提交commands给queues,我们能指定提交的commands进入等待状态直到特定list里的所有semaphores变为signaled.通过这种方式,我们可以协调提交到队列的工作,并推迟对依赖于其他命令结果的命令的处理.</p>
<p>当所有semaphores处于signaled且所有等待它们的命令恢复(变为un-signaled)然后复用.</p>
<p>semaphores也用于从swapchain请求images,此时,semaphores必须当我们向相关的images提交commands时使用.这些commands必须等待知道images不再被presentation engine使用.</p>
<p><img src="media/cbsemaphore.png" alt></p>
<p>vkCreateSemaphore</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">VkSemaphoreCreateInfo semaphore_create_info = &#123;</span><br><span class="line">    VK_STRUCTURE_TYPE_SEMAPHORE_CREATE_INFO,</span><br><span class="line">    <span class="literal">nullptr</span>,</span><br><span class="line">    <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line">VkResult result = vkCreateSemaphore( logical_device,</span><br><span class="line">&amp;semaphore_create_info, <span class="literal">nullptr</span>, &amp;semaphore );</span><br><span class="line"><span class="keyword">if</span>( VK_SUCCESS != result ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not create a semaphore."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>semaphores只能用于同步提交给queues的工作,位于硬件核心.app不能获得semaphore的状态,如果app需要同步提交了的commands需要使用fences.</p>
<h3 id="创建fences"><a href="#创建fences" class="headerlink" title="创建fences"></a>创建fences</h3><p>fences是用来同步app和提交给图形硬件的commands的.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">VkFenceCreateInfo fence_create_info = &#123;</span><br><span class="line">    VK_STRUCTURE_TYPE_FENCE_CREATE_INFO,</span><br><span class="line">    <span class="literal">nullptr</span>,</span><br><span class="line">    signaled ? VK_FENCE_CREATE_SIGNALED_BIT : <span class="number">0</span></span><br><span class="line">&#125;;</span><br><span class="line">VkResult result = vkCreateFence( logical_device, &amp;fence_create_info,</span><br><span class="line"><span class="literal">nullptr</span>, &amp;fence );</span><br><span class="line"><span class="keyword">if</span>( VK_SUCCESS != result ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not create a fence."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h3 id="wait-fences"><a href="#wait-fences" class="headerlink" title="wait fences"></a>wait fences</h3><p>vkWaitForFences</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( fences.size() &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">    VkResult result = vkWaitForFences( logical_device,</span><br><span class="line">    <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(fences.size()), &amp;fences[<span class="number">0</span>], wait_for_all, timeout );</span><br><span class="line">    <span class="keyword">if</span>( VK_SUCCESS != result ) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Waiting on fence failed."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<h3 id="reset-fences"><a href="#reset-fences" class="headerlink" title="reset fences"></a>reset fences</h3><p>semaphores自动reset,但当fence标记为signaled后,app负责reset.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( fences.size() &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">    VkResult result = vkResetFences( logical_device,</span><br><span class="line">    <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(fences.size()), &amp;fences[<span class="number">0</span>] );</span><br><span class="line">    <span class="keyword">if</span>( VK_SUCCESS != result ) &#123;</span><br><span class="line">        <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Error occurred when tried to reset fences."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> VK_SUCCESS == result;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<h2 id="submit"><a href="#submit" class="headerlink" title="submit"></a>submit</h2><h3 id="submit-command-buffers-to-a-queue"><a href="#submit-command-buffers-to-a-queue" class="headerlink" title="submit command buffers to a queue"></a>submit command buffers to a queue</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">WaitSemaphoreInfo</span> &#123;</span></span><br><span class="line">    VkSemaphore Semaphore;</span><br><span class="line">    VkPipelineStageFlags WaitingStage;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;VkSemaphore&gt; wait_semaphore_handles;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;VkPipelineStageFlags&gt; wait_semaphore_stages;</span><br><span class="line"><span class="keyword">for</span>( <span class="keyword">auto</span> &amp; wait_semaphore_info : wait_semaphore_infos ) &#123;</span><br><span class="line">wait_semaphore_handles.emplace_back( wait_semaphore_info.Semaphore );</span><br><span class="line">wait_semaphore_stages.emplace_back( wait_semaphore_info.WaitingStage );</span><br><span class="line">&#125;</span><br><span class="line">VkSubmitInfo submit_info = &#123;</span><br><span class="line">    VK_STRUCTURE_TYPE_SUBMIT_INFO,</span><br><span class="line">    <span class="literal">nullptr</span>,</span><br><span class="line">    <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(wait_semaphore_infos.size()),</span><br><span class="line">    wait_semaphore_handles.size() &gt; <span class="number">0</span> ? &amp;wait_semaphore_handles[<span class="number">0</span>] : <span class="literal">nullptr</span>,</span><br><span class="line">    wait_semaphore_stages.size() &gt; <span class="number">0</span> ? &amp;wait_semaphore_stages[<span class="number">0</span>] : <span class="literal">nullptr</span>,</span><br><span class="line">    <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(command_buffers.size()),</span><br><span class="line">    command_buffers.size() &gt; <span class="number">0</span> ? &amp;command_buffers[<span class="number">0</span>] : <span class="literal">nullptr</span>,</span><br><span class="line">    <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(signal_semaphores.size()),</span><br><span class="line">    signal_semaphores.size() &gt; <span class="number">0</span> ? &amp;signal_semaphores[<span class="number">0</span>] : <span class="literal">nullptr</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">VkResult result = vkQueueSubmit( <span class="built_in">queue</span>, <span class="number">1</span>, &amp;submit_info, fence );</span><br><span class="line"><span class="keyword">if</span>( VK_SUCCESS != result ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Error occurred during command buffer submission."</span> &lt;&lt;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>出于性能考虑,需要尽可能在少的dc中提交更多的batches</p>
<p>当一个cb提交后还没执行完,不能再次提交,除非使用flag:VK_COMMAND_BUFFER_USAGE_SIMULTANEOUS_USE_BIT,但为了性能考虑要尽量避免这个flag.</p>
<h3 id="同步两个cb"><a href="#同步两个cb" class="headerlink" title="同步两个cb"></a>同步两个cb</h3><p>semaphores</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct WaitSemaphoreInfo &#123;</span><br><span class="line">    VkSemaphore Semaphore;</span><br><span class="line">    VkPipelineStageFlags WaitingStage;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;VkSemaphore&gt; first_signal_semaphores;</span><br><span class="line"><span class="keyword">for</span>( <span class="keyword">auto</span> &amp; semaphore_info : synchronizing_semaphores ) &#123;</span><br><span class="line">	first_signal_semaphores.emplace_back( semaphore_info.Semaphore );</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>( !SubmitCommandBuffersToQueue( first_queue, first_wait_semaphore_infos,</span><br><span class="line">first_command_buffers, first_signal_semaphores, VK_NULL_HANDLE ) ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里同时使用handles和pipeline stages,第二个batch会等待特定pipeline stages的所有semaphores,这意味着提交的cbs部分会开始执行,当到达提供的stages时会暂停</p>
<p><img src="media/cbsemaphore2.png" alt></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( !SubmitCommandBuffersToQueue( second_queue, synchronizing_semaphores,</span><br><span class="line">second_command_buffers, second_signal_semaphores, second_fence ) ) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>这显示了如何同步从同一逻辑设备提交到不同队列的多个命令缓冲区的工作.从第二次提交开始的命令缓冲区处理将被推迟,直到第一批中的所有命令完成.</p>
<h3 id="检查提交后的cb是否完成"><a href="#检查提交后的cb是否完成" class="headerlink" title="检查提交后的cb是否完成"></a>检查提交后的cb是否完成</h3><p>当使用semaphores时,app没有被cb的同步给牵制.</p>
<p>当我们想知道cb何时结束,我们需要使用fences</p>
<p>创建fence,准备cb,提交给queue,记住提交时使用的fence</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( !SubmitCommandBuffersToQueue( <span class="built_in">queue</span>, wait_semaphore_infos,</span><br><span class="line">command_buffers, signal_semaphores, fence ) ) &#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>然后等待</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> WaitForFences( logical_device, &#123; fence &#125;, VK_FALSE, timeout );</span><br></pre></td></tr></table></figure>
<p>这样可以确保cb成功执行才开始接下来的任务.</p>
<p>但是,通常,渲染不应该造成app完全暂停.我们需要检查fence是否signaled,如果没有,就继续执行其他任务,比如ai、物理.当fence signaled,然后执行需要以来提交的commands状态的任务.</p>
<p>fences在我们想reuse cb时也有用,在我们re-cecord它们前,必须确保不再被device执行.我们需要有一定数量的command buffers 一个接一个 记录和提交.只有这样,我们使用其中一个时,就启动一个fence(每个submitted batch需要有一个关联的fence).分批的cb越多,花费在等待fences上的时间越少.(但效率不一定)</p>
<h3 id="等待queue的所有commands结束"><a href="#等待queue的所有commands结束" class="headerlink" title="等待queue的所有commands结束"></a>等待queue的所有commands结束</h3><p>并不总希望使用fences,app等待选择的queue执行结束也是可行的.</p>
<p>vkQueueWaitIdle</p>
<p>但这种同步在非常罕见的情况下执行.GPU比CPU快且可能需要不断提交工作以充分利用申请的性能.</p>
<p>在应用程序端执行等待可能会在图形硬件的管道中造成停顿，从而导致设备的利用效率低下</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">VkResult result = vkQueueWaitIdle( <span class="built_in">queue</span> );</span><br><span class="line"><span class="keyword">if</span>( VK_SUCCESS != result ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Waiting for all operations submitted to queue failed."</span> &lt;&lt;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h3 id="等待提交的commands结束"><a href="#等待提交的commands结束" class="headerlink" title="等待提交的commands结束"></a>等待提交的commands结束</h3><p>这种等待一般要关闭app和想要销毁创建的资源时用到</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">VkResult result = vkDeviceWaitIdle( logical_device );</span><br><span class="line"><span class="keyword">if</span>( VK_SUCCESS != result ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Waiting on a device failed."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h2 id="destroy"><a href="#destroy" class="headerlink" title="destroy"></a>destroy</h2><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( VK_NULL_HANDLE != fence ) &#123;</span><br><span class="line">    vkDestroyFence( logical_device, fence, <span class="literal">nullptr</span> );</span><br><span class="line">    fence = VK_NULL_HANDLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if( VK_NULL_HANDLE != semaphore ) &#123;</span><br><span class="line">    vkDestroySemaphore( logical_device, semaphore, nullptr );</span><br><span class="line">    semaphore = VK_NULL_HANDLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if( command_buffers.size() &gt; 0 ) &#123;</span><br><span class="line">    vkFreeCommandBuffers( logical_device, command_pool,</span><br><span class="line">    static_cast&lt;uint32_t&gt;(command_buffers.size()), &amp;command_buffers[0] );</span><br><span class="line">    command_buffers.clear();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">if( VK_NULL_HANDLE != command_pool ) &#123;</span><br><span class="line">    vkDestroyCommandPool( logical_device, command_pool, nullptr );</span><br><span class="line">    command_pool = VK_NULL_HANDLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/2.ImagePresentation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nolife">
      <meta itemprop="description" content="一个游戏程序员的blog">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stoner">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                
                <a href="/2019/04/05/sdk/graphics/vulkan/2.ImagePresentation/" class="post-title-link" itemprop="url">Image Presentation</a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-05 21:16:00 / Modified: 21:19:13" itemprop="dateCreated datePublished" datetime="2019-04-05T21:16:00+08:00">2019-04-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/" itemprop="url" rel="index"><span itemprop="name">sdk</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/vulkan/" itemprop="url" rel="index"><span itemprop="name">vulkan</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<p>[TOC]</p>
<h2 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h2><blockquote>
<ul>
<li>创建一个激活WSI扩展的Vulkan Instance</li>
<li>创建一个presentation surface</li>
<li>选择一个支持已给surface的queue family</li>
<li>创建一个有WSI扩展的logical device</li>
<li>选择一个期望的presentation mode</li>
<li>获得presentation surface的策略</li>
<li>设置swapchain images的大小</li>
<li>选择一个期望的swapchain iamges的方案</li>
<li>选择swapchain images交换方法</li>
<li>选择swapchain images格式</li>
<li>创建swapchain</li>
<li>获得swapchain images的handles</li>
<li>创建一个R8G8B8A8格式和mailbox显示模式的swapchain</li>
<li>请求一个swapchain image</li>
<li>销毁swapchain</li>
<li>销毁presentation surface</li>
</ul>
</blockquote>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Vulkan API本身由于跨平台考虑，本身不带有显示生成的图像到窗口的接口,但一组扩展接口(Windowing System Integration(WSI))支持了这种操作.每个支持Vulkan的操作系统有它自己的扩展.</p>
<p>最重要的扩展是允许我们创建一个swapchain.swapchain是一组images，能展示(显示)给用户.</p>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="instance-with-WSI-extensions"><a href="#instance-with-WSI-extensions" class="headerlink" title="instance with WSI extensions"></a>instance with WSI extensions</h3><p>WSI extension分为Instance 和device levels.</p>
<p>第一步是创建激活了对应扩展运行创建presentation surface的Vulkan Instance</p>
<p>Instance-level extensions负责管理、创建、销毁一个presentation surface.它是一个软件的窗口的(跨平台的)representation.通过它,我们能检查是否能绘制窗口(显示图片、一个queue family的额外属性)，能知道它的参数，它支持什么(如果向垂直同步激活或关闭).</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">desired_extensions.emplace_back( VK_KHR_SURFACE_EXTENSION_NAME );<span class="comment">//所有os都支持,用于管理、删除khr</span></span><br><span class="line">desired_extensions.emplace_back(</span><br><span class="line">#ifdef VK_USE_PLATFORM_WIN32_KHR </span><br><span class="line">VK_KHR_WIN32_SURFACE_EXTENSION_NAME <span class="comment">//windows</span></span><br><span class="line">#elif defined VK_USE_PLATFORM_XCB_KHR</span><br><span class="line">VK_KHR_XCB_SURFACE_EXTENSION_NAME <span class="comment">//linux xcb</span></span><br><span class="line">#elif defined VK_USE_PLATFORM_XLIB_KHR</span><br><span class="line">VK_KHR_XLIB_SURFACE_EXTENSION_NAME <span class="comment">//linux xlib</span></span><br><span class="line">#endif</span><br><span class="line">);</span><br><span class="line"><span class="keyword">return</span> CreateVulkanInstance( desired_extensions, application_name, instance</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="创建presentation-surface"><a href="#创建presentation-surface" class="headerlink" title="创建presentation surface"></a>创建presentation surface</h3><p>presentation显示软件的窗口,允许我们获取窗口的参数(比如尺寸,支持的颜色格式,请求的images数量,或者显示模式).</p>
<p>前提:windows已经创建</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">WindowParameters</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> VK_USE_PLATFORM_WIN32_KHR</span></span><br><span class="line">HINSTANCE HInstance;</span><br><span class="line">HWND HWnd;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined VK_USE_PLATFORM_XLIB_KHR</span></span><br><span class="line">Display * Dpy;</span><br><span class="line">Window Window;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined VK_USE_PLATFORM_XCB_KHR</span></span><br><span class="line"><span class="keyword">xcb_connection_t</span> * Connection;</span><br><span class="line"><span class="keyword">xcb_window_t</span> Window;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> VK_USE_PLATFORM_WIN32_KHR</span></span><br><span class="line">VkWin32SurfaceCreateInfoKHR surface_create_info = &#123;</span><br><span class="line">VK_STRUCTURE_TYPE_WIN32_SURFACE_CREATE_INFO_KHR,</span><br><span class="line"><span class="literal">nullptr</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">window_parameters.HInstance,</span><br><span class="line">window_parameters.HWnd</span><br><span class="line">&#125;;</span><br><span class="line">VkResult result = vkCreateWin32SurfaceKHR( instance, &amp;surface_create_info,</span><br><span class="line"><span class="literal">nullptr</span>, &amp;presentation_surface );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined VK_USE_PLATFORM_XLIB_KHR</span></span><br><span class="line">VkXlibSurfaceCreateInfoKHR surface_create_info = &#123;</span><br><span class="line">VK_STRUCTURE_TYPE_XLIB_SURFACE_CREATE_INFO_KHR,</span><br><span class="line"><span class="literal">nullptr</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">window_parameters.Dpy,</span><br><span class="line">window_parameters.Window</span><br><span class="line">&#125;;</span><br><span class="line">VkResult result = vkCreateXlibSurfaceKHR( instance, &amp;surface_create_info,</span><br><span class="line"><span class="literal">nullptr</span>, &amp;presentation_surface );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined VK_USE_PLATFORM_XCB_KHR</span></span><br><span class="line">VkXcbSurfaceCreateInfoKHR surface_create_info = &#123;</span><br><span class="line">VK_STRUCTURE_TYPE_XCB_SURFACE_CREATE_INFO_KHR,</span><br><span class="line"><span class="literal">nullptr</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">window_parameters.Connection,</span><br><span class="line">window_parameters.Window</span><br><span class="line">&#125;;</span><br><span class="line">VkResult result = vkCreateXcbSurfaceKHR( instance, &amp;surface_create_info,</span><br><span class="line"><span class="literal">nullptr</span>, &amp;presentation_surface );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h3 id="选择支持给定表面显示的queue-family"><a href="#选择支持给定表面显示的queue-family" class="headerlink" title="选择支持给定表面显示的queue family"></a>选择支持给定表面显示的queue family</h3><p>显示图像是通过提交特色的command到device的queue实现的.所以要求对应的queue支持.</p>
<p>目前queue family可能支持的特性有:Image presentation,graphics,compute,transfer,sparse operations.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>( <span class="keyword">uint32_t</span> index = <span class="number">0</span>; index &lt;</span><br><span class="line"><span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(queue_families.size()); ++index ) &#123;</span><br><span class="line">VkBool32 presentation_supported = VK_FALSE;</span><br><span class="line">VkResult result = vkGetPhysicalDeviceSurfaceSupportKHR( physical_device,</span><br><span class="line">index, presentation_surface, &amp;presentation_supported );</span><br><span class="line"><span class="keyword">if</span>( (VK_SUCCESS == result) &amp;&amp;</span><br><span class="line">(VK_TRUE == presentation_supported) ) &#123;</span><br><span class="line">queue_family_index = index;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>通过vkGetPhysicalDeviceSurfaceSupportKHR接口进行检查</p>
<h3 id="logical-device-with-WSI-extensions"><a href="#logical-device-with-WSI-extensions" class="headerlink" title="logical device with WSI extensions"></a>logical device with WSI extensions</h3><p>一个device-level WSI扩展允许创建一个swapchain.这是一组被presentation engine管理的images.</p>
<p>VK_KHR_swapchain</p>
<p>一个swapchain,列举了image format,images 数量(双缓存或三缓存),presentation mode(v-sync 激活/关闭).伴随着swapchain创建的images被presentation engine所有和管理.需要使用时,需要请求,绘制,归还到presentation engine.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">desired_extensions.emplace_back( VK_KHR_SWAPCHAIN_EXTENSION_NAME );</span><br><span class="line"><span class="keyword">return</span> CreateLogicalDevice( physical_device, queue_infos,</span><br><span class="line">desired_extensions, desired_features, logical_device );</span><br></pre></td></tr></table></figure>
<h3 id="选择期望的presentation-mode"><a href="#选择期望的presentation-mode" class="headerlink" title="选择期望的presentation mode"></a>选择期望的presentation mode</h3><p>vulkan的swapchain最重要的特性是将图像显示倒屏幕,也是swap’chain的设计目的.</p>
<p>有四种模式.</p>
<p>最简单的是IMMEDIATE模式.会有屏幕撕裂现象</p>
<p><img src="media/presentatinsurface1.png" alt></p>
<p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD<br>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD<br>Vulkan API实现都必须支持的是FIFO模式.   </p>
<p>FIFO RELAXED是FIFO的简单变体.不同之处是RELAXED模式,只有当图像显示足够快,比刷新率还快时才会在空白期显示图像到屏幕上.如果应用程序显示了一个图像,并且从上次显示到现在所花费的时间大于两个空白周期之间的刷新时间(FIFO queue为空),图像立即显示.因此如果足够快,这里不会有撕裂,但如果绘制得比屏幕刷新慢，会出现撕裂.这个mode与OpenGL的EXT_swap_control_tear扩展类似.</p>
<p><img src="media/swapchainFIFO.png" alt></p>
<p>最后一种为mailbox模式.它可以被看做是三重缓冲.有一个只包含一个元素的队列.一个image在这个队列里等待在空白期同步显示(v-sync激活)显示.但当app显示一张image时,新的一张新的image会替换掉队列里的.所以presentation engine总是显示最新的,没有屏幕撕裂.</p>
<p><img src="media/swapchainmailbox.png" alt></p>
<p>检查可用modes.vkGetPhysicalDeviceSurfacePresentModesKHR.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> present_modes_count = <span class="number">0</span>;</span><br><span class="line">VkResult result = VK_SUCCESS;</span><br><span class="line">result = vkGetPhysicalDeviceSurfacePresentModesKHR( physical_device,</span><br><span class="line">presentation_surface, &amp;present_modes_count, <span class="literal">nullptr</span> );</span><br><span class="line"><span class="keyword">if</span>( (VK_SUCCESS != result) ||</span><br><span class="line">(<span class="number">0</span> == present_modes_count) ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not get the number of supported present modes."</span> &lt;&lt;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;VkPresentModeKHR&gt; present_modes( present_modes_count );</span><br><span class="line">result = vkGetPhysicalDeviceSurfacePresentModesKHR( physical_device,</span><br><span class="line">presentation_surface, &amp;present_modes_count, &amp;present_modes[<span class="number">0</span>] );</span><br><span class="line"><span class="keyword">if</span>( (VK_SUCCESS != result) ||</span><br><span class="line">(<span class="number">0</span> == present_modes_count) ) &#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not enumerate present modes."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获得了支持的所有modes后,选择一个期望的.如果不支持则选择默认的FIFO(总被支持).</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>( <span class="keyword">auto</span> &amp; current_present_mode : present_modes ) &#123;</span><br><span class="line"><span class="keyword">if</span>( current_present_mode == desired_present_mode ) &#123;</span><br><span class="line">present_mode = desired_present_mode;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Desired present mode is not supported. Selecting default FIFO</span></span><br><span class="line"><span class="string">mode."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">for</span>( <span class="keyword">auto</span> &amp; current_present_mode : present_modes ) &#123;</span><br><span class="line"><span class="keyword">if</span>( current_present_mode == VK_PRESENT_MODE_FIFO_KHR ) &#123;</span><br><span class="line">present_mode = VK_PRESENT_MODE_FIFO_KHR;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获得一个presentation-surface的功能"><a href="#获得一个presentation-surface的功能" class="headerlink" title="获得一个presentation surface的功能"></a>获得一个presentation surface的功能</h3><p>当创建一个swapchain时,不能选择我们想要的值而是指定参数.必须提供被presentation surface支持的限制范围内的值.因此为了正确创建swapchain,我们需要获得surface的功能.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">VkResult result = vkGetPhysicalDeviceSurfaceCapabilitiesKHR(</span><br><span class="line">physical_device, presentation_surface, &amp;surface_capabilities );</span><br><span class="line"><span class="keyword">if</span>( VK_SUCCESS != result ) &#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not get the capabilities of a presentation surface."</span></span><br><span class="line">&lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>VkSurfaceCapabilitiesKHR</p>
<blockquote>
<ul>
<li>swapchain images的最小和最大允许数量</li>
<li>表面的最小、最大、当前范围</li>
<li>支持图像转换(在显示前应用),其实就是是否进行sRGB转换,可能在不同平台支持特性不同,也就是要注意是否要自己进行转换</li>
<li>image layers最大数量</li>
<li>支持的usages</li>
<li>支持曲面的alpha值(图像的alpha组件该如何影响应用程序的窗口桌面合成)的支持的组件列表</li>
</ul>
</blockquote>
<p>内容包括</p>
<blockquote>
<ul>
<li>创建一个presentation surface</li>
<li>select swapchain images的个数</li>
<li>choose swapchain images的尺寸</li>
<li>select swapchain chains的期望的usage</li>
<li>select swapchain images的transformation</li>
<li>select swapchain images的format</li>
<li>创建一个swapchain</li>
</ul>
</blockquote>
<h3 id="select-swapchain-iamges的数量"><a href="#select-swapchain-iamges的数量" class="headerlink" title="select swapchain iamges的数量"></a>select swapchain iamges的数量</h3><p>当app想向swapchain image里渲染时,必须向prsentation engine请求它.app可以请求多张images,不限制一次请求一张.但可用的images(presentation engine 没在使用的)数量与presentation mode,app当前状态(渲染、显示的历史),images数量(创建swapchain时指定(最小))有关.</p>
<p>相关结构</p>
<p>VkSurfaceCapabilitiesKHR</p>
<blockquote>
<p>.minImageCount,一般将minImageCount.+1作为请求数量</p>
<p>.maxImageCount,如果&gt;0则对能创建的images最大数量有限制,就需要修正请求的images 数量了</p>
</blockquote>
<p>伴随swapchain创经济的images主要用作显示目的.但它们也表示引擎正常工作.知道它被替换,app不能使用它(image).images立即替换现实中的image或者在队列里等待替换它(v-sync)–基于选择的mode.app只能请求处于unused 状态的image.(可以请求所有unused状态的images).但同时,需要present至少一张image,否则请求操作会死锁.</p>
<p>未使用的映像的数量主要取决于表示模式和使用swapchain创建的images的总数.因此,我们想要创建的图像的数量应该根据我们想要实现的呈现场景(应用程序想同时拥有多少图像)和所选的当前模式来选择.</p>
<p>请求最小数量的Images:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">number_of_images = surface_capabilities.minImageCount + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span>( (surface_capabilities.maxImageCount &gt; <span class="number">0</span>) &amp;&amp;</span><br><span class="line">(number_of_images &gt; surface_capabilities.maxImageCount) ) &#123;</span><br><span class="line">number_of_images = surface_capabilities.maxImageCount;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>Vulkan API实现都必须支持的是FIFO模式.</p>
<p>选择需求需要的images数量</p>
<h3 id="choose-swapchain-images-size"><a href="#choose-swapchain-images-size" class="headerlink" title="choose swapchain images size *"></a>choose swapchain images size *</h3><p>通常要适合window大小,支持的dimensions再presentation surface的属性里有.但有的操作系统,iamges的size决定了最终window的大小.</p>
<p>同时也要记住去检查swapchain images的适合的dimensions.</p>
<p>相关结构</p>
<p>VkSurfaceCapabilitiesKHR</p>
<p>VkExtent2D</p>
<p>检查</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果surface_capabilities.currentExtent.width==-1</span></span><br><span class="line"><span class="comment">//则image的size决定windows的size</span></span><br><span class="line"><span class="keyword">if</span>( <span class="number">0xFFFFFFFF</span> == surface_capabilities.currentExtent.width ) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//这种情况就根据surface 属性调节image size</span></span><br><span class="line">    size_of_images = &#123; <span class="number">640</span>, <span class="number">480</span> &#125;;</span><br><span class="line">    <span class="comment">//范围检查</span></span><br><span class="line">    <span class="keyword">if</span>( size_of_images.width &lt; surface_capabilities.minImageExtent.width ) </span><br><span class="line">    &#123;</span><br><span class="line">    	size_of_images.width = surface_capabilities.minImageExtent.width;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( size_of_images.width &gt;</span><br><span class="line">    surface_capabilities.maxImageExtent.width ) </span><br><span class="line">    &#123;</span><br><span class="line">    	size_of_images.width = surface_capabilities.maxImageExtent.width;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( size_of_images.height &lt; surface_capabilities.minImageExtent.height )</span><br><span class="line">    &#123;</span><br><span class="line">    	size_of_images.height = surface_capabilities.minImageExtent.height;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( size_of_images.height &gt; surface_capabilities.maxImageExtent.height ) </span><br><span class="line">    &#123;</span><br><span class="line">    	size_of_images.height = surface_capabilities.maxImageExtent.height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//这种情况就将surface的size作为images的size</span></span><br><span class="line">    size_of_images = surface_capabilities.currentExtent;<span class="comment">//currentExtent是创建的windows尺寸</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>​    正常情况是将windows size作为images的size,但有的os是swapchain images的尺寸决定的.</p>
<h3 id="select-所需的swapchain-iamges使用场景"><a href="#select-所需的swapchain-iamges使用场景" class="headerlink" title="select 所需的swapchain iamges使用场景"></a>select 所需的swapchain iamges使用场景</h3><p>伴随swapchain创建的images常用作color attachments(VK_IMAGE_USAGE_COLOR_ATTACHMENT_BIT).也就是说我们想向它们渲染东西(RT).但不限于此.也有其他用处:可以进行采样,在copy操作时作为数据源,或者作为拷贝目标.这些都是在创建swapchain时的不同的使用usages,但是需要检查usages是否支持.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">image_usage = desired_usages &amp; surface_capabilities.supportedUsageFlags;</span><br><span class="line">return desired_usages == image_usage;</span><br></pre></td></tr></table></figure>
<h3 id="select-a-transformation-of-swapchain-images"><a href="#select-a-transformation-of-swapchain-images" class="headerlink" title="select a transformation of swapchain images"></a>select a transformation of swapchain images</h3><p>有的(尤其是手机)设备,images能从不同orientations看,有时需要控制图像显示到屏幕上时面向.Vulkan能做到这点,能在显示前指定图像的转换.</p>
<p>相关结构</p>
<p>VkSurfaceTransformFlagBitsKHR</p>
<p>Transformations定义了image在显示到屏幕前如何旋转、镜像.在swapchain创建时,能够指定期望的transformation和presentation engine,并作为显示过程的一部分.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( surface_capabilities.supportedTransforms &amp; desired_transform ) &#123;</span><br><span class="line">surface_transform = desired_transform;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">surface_transform = surface_capabilities.currentTransform;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="select-一种swapchain-images-格式"><a href="#select-一种swapchain-images-格式" class="headerlink" title="select 一种swapchain images 格式"></a>select 一种swapchain images 格式</h3><p>format定义了color分量的数量和每个分量的bits和数据类型.在创建swapchain时</p>
<blockquote>
<p>需要决定使用的颜色通道</p>
<p>是否使用uint或float类型</p>
<p>精度</p>
<p>线性、非线性颜色.</p>
</blockquote>
<p>​    但只能选择被支持的特性.</p>
<p>相关结构</p>
<p>VkFormat</p>
<p>VkColorSpaceKHR</p>
<p>VkSurfaceFormatKHR</p>
<p>VkSurfaceKHR</p>
<p>获得所有支持的formats,调用两次vkGetPhysicalDeviceSurfaceFormatsKHR,存在列表VkSurfaceFormatKHR里,如果只返回一个VK_FORMAT_UNDEFINED,也就是说对format没有限制.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( (<span class="number">1</span> == surface_formats.size()) &amp;&amp;</span><br><span class="line">(VK_FORMAT_UNDEFINED == surface_formats[<span class="number">0</span>].format) ) &#123;</span><br><span class="line">image_format = desired_surface_format.format;</span><br><span class="line">image_color_space = desired_surface_format.colorSpace;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当返回一系列的VkSurfaceFormatKHR时,需要选择image format好color space都支持的.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>( <span class="keyword">auto</span> &amp; surface_format : surface_formats ) &#123;</span><br><span class="line"><span class="keyword">if</span>( (desired_surface_format.format == surface_format.format) &amp;&amp;</span><br><span class="line">(desired_surface_format.colorSpace == surface_format.colorSpace) ) &#123;</span><br><span class="line">image_format = desired_surface_format.format;</span><br><span class="line">image_color_space = desired_surface_format.colorSpace;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后,如果期望公式不支持,选择第一个吧</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">image_format = surface_formats[<span class="number">0</span>].format;</span><br><span class="line">image_color_space = surface_formats[<span class="number">0</span>].colorSpace;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Desired format is not supported. Selecting available format -</span></span><br><span class="line"><span class="string">colorspace combination."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h3 id="创建swapchain"><a href="#创建swapchain" class="headerlink" title="创建swapchain"></a>创建swapchain</h3><p>一个swapchain用于显示images到屏幕上.那是一组能被app请求并显示到app窗口上的images.它们有相同的属性(properties).当准备好所有的参数:数量,size,format,swapchain images的使用usage,选择一个支持的先试试modes,就可以创建swapchain了.</p>
<p>一个swapchain是一组Images,伴随swapchain自动创建、销毁.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">VkSwapchainCreateInfoKHR swapchain_create_info = &#123;</span><br><span class="line">VK_STRUCTURE_TYPE_SWAPCHAIN_CREATE_INFO_KHR,</span><br><span class="line"><span class="literal">nullptr</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">presentation_surface,<span class="comment">//surface</span></span><br><span class="line">image_count,<span class="comment">//minImageCount</span></span><br><span class="line">surface_format.format,</span><br><span class="line">surface_format.colorSpace,<span class="comment">//imageColorSpace</span></span><br><span class="line">image_size,</span><br><span class="line"><span class="number">1</span>,<span class="comment">//imageArrayLayers</span></span><br><span class="line">image_usage,</span><br><span class="line">VK_SHARING_MODE_EXCLUSIVE,<span class="comment">//imageSharingMode</span></span><br><span class="line"><span class="number">0</span>,<span class="comment">//queueFamilyIndexCount</span></span><br><span class="line"><span class="literal">nullptr</span>,</span><br><span class="line">surface_transform,</span><br><span class="line">VK_COMPOSITE_ALPHA_OPAQUE_BIT_KHR,</span><br><span class="line">present_mode,</span><br><span class="line">VK_TRUE,</span><br><span class="line">old_swapchain</span><br><span class="line">&#125;;</span><br><span class="line">VkResult result = vkCreateSwapchainKHR( logical_device,</span><br><span class="line">&amp;swapchain_create_info, <span class="literal">nullptr</span>, &amp;swapchain );</span><br><span class="line"><span class="keyword">if</span>( (VK_SUCCESS != result) ||</span><br><span class="line">(VK_NULL_HANDLE == swapchain) ) &#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not create a swapchain."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vkDestroySwapchainKHR</span><br></pre></td></tr></table></figure>
<p>一个app的窗口只能关联一个swapchain,当创建一个新的swapchain时,需要销毁之前为这个窗口创建的swapchain.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( VK_NULL_HANDLE != old_swapchain ) &#123;</span><br><span class="line">vkDestroySwapchainKHR( logical_device, old_swapchain, <span class="literal">nullptr</span> );</span><br><span class="line">old_swapchain = VK_NULL_HANDLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获得swapchain-images的handles"><a href="#获得swapchain-images的handles" class="headerlink" title="获得swapchain images的handles"></a>获得swapchain images的handles</h3><p>vkGetSwapchainImagesKHR</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> images_count = <span class="number">0</span>;</span><br><span class="line">VkResult result = VK_SUCCESS;</span><br><span class="line">result = vkGetSwapchainImagesKHR( logical_device, swapchain, &amp;images_count,</span><br><span class="line"><span class="literal">nullptr</span> );</span><br><span class="line"><span class="keyword">if</span>( (VK_SUCCESS != result) ||</span><br><span class="line">(<span class="number">0</span> == images_count) ) &#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not get the number of swapchain images."</span> &lt;&lt;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">swapchain_images.resize( images_count );</span><br><span class="line">result = vkGetSwapchainImagesKHR( logical_device, swapchain, &amp;images_count,</span><br><span class="line">&amp;swapchain_images[<span class="number">0</span>] );</span><br><span class="line"><span class="keyword">if</span>( (VK_SUCCESS != result) ||</span><br><span class="line">(<span class="number">0</span> == images_count) ) &#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not enumerate swapchain images."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>驱动可能创建多余创建swapchain时传参数量的images.我们设置了最小数量,但vulkan实现时可能创建更多.</p>
<p>vulkan中,如果想绘制一个image需要有它的handle.需要创建一个包裹image的image view且在创建framebuffer时用到.framebuffer时一组在渲染过程中用到的images.</p>
<p>得到得是一个数而不是handle本身.这个数字表示使用vkGetSwapchainImagesKHR得到的images数组的索引.因此了解images总数、顺序、handles对于正确使用swapchain和images很必要.</p>
<h3 id="创建一个swapchain-R8G8B8A8-format-amp-mailbox显示模式"><a href="#创建一个swapchain-R8G8B8A8-format-amp-mailbox显示模式" class="headerlink" title="创建一个swapchain(R8G8B8A8 format &amp; mailbox显示模式)"></a>创建一个swapchain(R8G8B8A8 format &amp; mailbox显示模式)</h3><p>无transformations,标准color attachment image usage.</p>
<p>已有设施</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">VkPhysicalDevice physical_device;</span><br><span class="line">VkSurfaceKHR presentation_surface;</span><br><span class="line">VkDevice logical_device;</span><br><span class="line">VkSwapchainKHR old_swapchain;</span><br><span class="line">VkPresentModeKHR desired_present_mode;</span><br><span class="line">VkSurfaceCapabilitiesKHR surface_capabilities;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uint32_t number_of_images;</span><br><span class="line">VkExtent2D image_size;</span><br><span class="line">VkImageUsageFlags image_usage = VK_IMAGE_USAGE_COLOR_ATTACHMENT_BIT;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">VkPresentModeKHR desired_present_mode;</span><br><span class="line">if( !SelectDesiredPresentationMode( physical_device, presentation_surface,</span><br><span class="line">VK_PRESENT_MODE_MAILBOX_KHR, desired_present_mode ) ) &#123;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line">VkSurfaceCapabilitiesKHR surface_capabilities;</span><br><span class="line">if( !GetCapabilitiesOfPresentationSurface( physical_device,</span><br><span class="line">presentation_surface, surface_capabilities ) ) &#123;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line">uint32_t number_of_images;</span><br><span class="line">if( !SelectNumberOfSwapchainImages( surface_capabilities, number_of_images</span><br><span class="line">) ) &#123;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line">VkExtent2D image_size;</span><br><span class="line">if( !ChooseSizeOfSwapchainImages( surface_capabilities, image_size ) ) &#123;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line">if( (0 == image_size.width) ||</span><br><span class="line">(0 == image_size.height) ) &#123;</span><br><span class="line">	return true;</span><br><span class="line">&#125;</span><br><span class="line">VkImageUsageFlags image_usage;</span><br><span class="line">if( !SelectDesiredUsageScenariosOfSwapchainImages( surface_capabilities,</span><br><span class="line">VK_IMAGE_USAGE_COLOR_ATTACHMENT_BIT, image_usage ) ) &#123;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line">VkSurfaceTransformFlagBitsKHR surface_transform;</span><br><span class="line">SelectTransformationOfSwapchainImages( surface_capabilities,</span><br><span class="line">VK_SURFACE_TRANSFORM_IDENTITY_BIT_KHR, surface_transform );</span><br><span class="line">VkFormat image_format;</span><br><span class="line">VkColorSpaceKHR image_color_space;</span><br><span class="line">if( !SelectFormatOfSwapchainImages( physical_device, presentation_surface,</span><br><span class="line">&#123; VK_FORMAT_R8G8B8A8_UNORM, VK_COLOR_SPACE_SRGB_NONLINEAR_KHR &#125;,</span><br><span class="line">image_format, image_color_space ) ) &#123;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if( !CreateSwapchain( logical_device, presentation_surface,</span><br><span class="line">number_of_images, &#123; image_format, image_color_space &#125;, image_size,</span><br><span class="line">image_usage, surface_transform, desired_present_mode, old_swapchain,</span><br><span class="line">swapchain ) ) &#123;</span><br><span class="line">return false;</span><br><span class="line">&#125;</span><br><span class="line">if( !GetHandlesOfSwapchainImages( logical_device, swapchain,</span><br><span class="line">swapchain_images ) ) &#123;</span><br><span class="line">return false;</span><br><span class="line">&#125;</span><br><span class="line">return true;</span><br></pre></td></tr></table></figure>
<h3 id="获得swapchain-iamge"><a href="#获得swapchain-iamge" class="headerlink" title="获得swapchain iamge"></a>获得swapchain iamge</h3><p>vkGetSwapchainImagesKHR</p>
<p>semaphores和fences</p>
<p>semphores用于同步device的queues.不能用于同步app的commands提交.</p>
<p>fences app</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">VkResult result;</span><br><span class="line">result = vkAcquireNextImageKHR( logical_device, swapchain, <span class="number">2000000000</span>,</span><br><span class="line">semaphore, fence, &amp;image_index );</span><br><span class="line"><span class="keyword">switch</span>( result ) &#123;</span><br><span class="line"><span class="keyword">case</span> VK_SUCCESS:</span><br><span class="line"><span class="keyword">case</span> VK_SUBOPTIMAL_KHR:</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在immediate模式下,可能images都不可用,也就是可能失败.第三个参数是一个超时参数(ns),</p>
<p>如果要让驱动在处理commands前进行等待,semaphore会用到.</p>
<p>app侧等待性能影响更大.</p>
<p>返回值也很重要</p>
<p>如果返回VK_SUBOPTIMAL_KHR,意味着我们能用这个image,但它不再最适合presentation engine.需要重新创建swapchain.但不必立即做.</p>
<p>当返回VK_ERROR_OUT_OF_DATE_KHR时,image就不能用了,我们需要立即重建swapchain.</p>
<p>对于swapchain最后需要注意的时在能使用一张image前,我们需要改变(transition)它的layout,layout时image的内部内存组织–可能跟当前目的不同.如果想用于不同目的就修改它的layout.</p>
<p>比如,用于presentation engine的images必须有VK_IMAGE_LAYOUT_PRESENT_SRC_KHR层.如果用于渲染必须有VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL,改变layout的操作称为transition.</p>
<h3 id="present-an-image"><a href="#present-an-image" class="headerlink" title="present an image"></a>present an image</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PresentInfo</span> &#123;</span></span><br><span class="line">    VkSwapchainKHR Swapchain;</span><br><span class="line">    <span class="keyword">uint32_t</span> ImageIndex;<span class="comment">//想显示的image index</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">VkPresentInfoKHR present_info = &#123;</span><br><span class="line">    VK_STRUCTURE_TYPE_PRESENT_INFO_KHR,</span><br><span class="line">    <span class="literal">nullptr</span>,</span><br><span class="line">    <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(rendering_semaphores.size()),</span><br><span class="line">    rendering_semaphores.size() &gt; <span class="number">0</span> ? &amp;rendering_semaphores[<span class="number">0</span>] : <span class="literal">nullptr</span>,</span><br><span class="line">    <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(swapchains.size()),</span><br><span class="line">    swapchains.size() &gt; <span class="number">0</span> ? &amp;swapchains[<span class="number">0</span>] : <span class="literal">nullptr</span>,</span><br><span class="line">    swapchains.size() &gt; <span class="number">0</span> ? &amp;image_indices[<span class="number">0</span>] : <span class="literal">nullptr</span>,</span><br><span class="line">    <span class="literal">nullptr</span></span><br><span class="line">&#125;;</span><br><span class="line">result = vkQueuePresentKHR( <span class="built_in">queue</span>, &amp;present_info );</span><br><span class="line"><span class="keyword">switch</span>( result ) &#123;</span><br><span class="line">    <span class="keyword">case</span> VK_SUCCESS:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在提交image前,需要修改其layout为VK_IMAGE_LAYOUT_PRESENT_SRC_KHR否则presentation engine可能无法显示它.</p>
<p>当提交命令时,rendering_semaphores用于同步</p>
<h3 id="destroy"><a href="#destroy" class="headerlink" title="destroy"></a>destroy</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( swapchain ) &#123;</span><br><span class="line">    vkDestroySwapchainKHR( logical_device, swapchain, <span class="literal">nullptr</span> );</span><br><span class="line">    swapchain = VK_NULL_HANDLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( presentation_surface ) &#123;</span><br><span class="line">    vkDestroySurfaceKHR( instance, presentation_surface, <span class="literal">nullptr</span> );</span><br><span class="line">    presentation_surface = VK_NULL_HANDLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <div class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">nolife</p>
              <div class="site-description motion-element" itemprop="description">一个游戏程序员的blog</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">17</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">nolife</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.1"></script>



  

  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  



  




  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
