<!DOCTYPE html>












  


<html class="theme-next muse use-motion" lang="en">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">


























<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.1">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.1">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.1">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.1" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    version: '7.0.1',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false,"dimmer":false},
    back2top: true,
    back2top_sidebar: false,
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="[TOC] 内容  创建一个激活WSI扩展的Vulkan Instance 创建一个presentation surface 选择一个支持已给surface的queue family 创建一个有WSI扩展的logical device 选择一个期望的presentation mode 获得presentation surface的策略 设置swapchain images的大小 选择一个期望的s">
<meta name="keywords" content="vulkan">
<meta property="og:type" content="article">
<meta property="og:title" content="Image Presentation">
<meta property="og:url" content="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/2.ImagePresentation/index.html">
<meta property="og:site_name" content="Stoner">
<meta property="og:description" content="[TOC] 内容  创建一个激活WSI扩展的Vulkan Instance 创建一个presentation surface 选择一个支持已给surface的queue family 创建一个有WSI扩展的logical device 选择一个期望的presentation mode 获得presentation surface的策略 设置swapchain images的大小 选择一个期望的s">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/2.ImagePresentation/media/presentatinsurface1.png">
<meta property="og:image" content="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/2.ImagePresentation/media/swapchainFIFO.png">
<meta property="og:image" content="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/2.ImagePresentation/media/swapchainmailbox.png">
<meta property="og:updated_time" content="2019-04-05T13:19:13.748Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Image Presentation">
<meta name="twitter:description" content="[TOC] 内容  创建一个激活WSI扩展的Vulkan Instance 创建一个presentation surface 选择一个支持已给surface的queue family 创建一个有WSI扩展的logical device 选择一个期望的presentation mode 获得presentation surface的策略 设置swapchain images的大小 选择一个期望的s">
<meta name="twitter:image" content="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/2.ImagePresentation/media/presentatinsurface1.png">






  <link rel="canonical" href="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/2.ImagePresentation/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Image Presentation | Stoner</title>
  












  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Stoner</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">做此刻最想做的事</p>
      
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="Toggle navigation bar">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>Home</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>Tags</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>Categories</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>Archives</a>

  </li>

      
      
    </ul>
  

  
    

  

  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://noleafnolife.com/2019/04/05/sdk/graphics/vulkan/2.ImagePresentation/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="nolife">
      <meta itemprop="description" content="一个游戏程序员的blog">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Stoner">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Image Presentation

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              

              
                
              

              <time title="Created: 2019-04-05 21:16:00 / Modified: 21:19:13" itemprop="dateCreated datePublished" datetime="2019-04-05T21:16:00+08:00">2019-04-05</time>
            

            
              

              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/" itemprop="url" rel="index"><span itemprop="name">sdk</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/" itemprop="url" rel="index"><span itemprop="name">graphics</span></a></span>

                
                
                  , 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/sdk/graphics/vulkan/" itemprop="url" rel="index"><span itemprop="name">vulkan</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <a id="more"></a>
<p>[TOC]</p>
<h2 id="内容"><a href="#内容" class="headerlink" title="内容"></a>内容</h2><blockquote>
<ul>
<li>创建一个激活WSI扩展的Vulkan Instance</li>
<li>创建一个presentation surface</li>
<li>选择一个支持已给surface的queue family</li>
<li>创建一个有WSI扩展的logical device</li>
<li>选择一个期望的presentation mode</li>
<li>获得presentation surface的策略</li>
<li>设置swapchain images的大小</li>
<li>选择一个期望的swapchain iamges的方案</li>
<li>选择swapchain images交换方法</li>
<li>选择swapchain images格式</li>
<li>创建swapchain</li>
<li>获得swapchain images的handles</li>
<li>创建一个R8G8B8A8格式和mailbox显示模式的swapchain</li>
<li>请求一个swapchain image</li>
<li>销毁swapchain</li>
<li>销毁presentation surface</li>
</ul>
</blockquote>
<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>Vulkan API本身由于跨平台考虑，本身不带有显示生成的图像到窗口的接口,但一组扩展接口(Windowing System Integration(WSI))支持了这种操作.每个支持Vulkan的操作系统有它自己的扩展.</p>
<p>最重要的扩展是允许我们创建一个swapchain.swapchain是一组images，能展示(显示)给用户.</p>
<h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><h3 id="instance-with-WSI-extensions"><a href="#instance-with-WSI-extensions" class="headerlink" title="instance with WSI extensions"></a>instance with WSI extensions</h3><p>WSI extension分为Instance 和device levels.</p>
<p>第一步是创建激活了对应扩展运行创建presentation surface的Vulkan Instance</p>
<p>Instance-level extensions负责管理、创建、销毁一个presentation surface.它是一个软件的窗口的(跨平台的)representation.通过它,我们能检查是否能绘制窗口(显示图片、一个queue family的额外属性)，能知道它的参数，它支持什么(如果向垂直同步激活或关闭).</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">desired_extensions.emplace_back( VK_KHR_SURFACE_EXTENSION_NAME );<span class="comment">//所有os都支持,用于管理、删除khr</span></span><br><span class="line">desired_extensions.emplace_back(</span><br><span class="line">#ifdef VK_USE_PLATFORM_WIN32_KHR </span><br><span class="line">VK_KHR_WIN32_SURFACE_EXTENSION_NAME <span class="comment">//windows</span></span><br><span class="line">#elif defined VK_USE_PLATFORM_XCB_KHR</span><br><span class="line">VK_KHR_XCB_SURFACE_EXTENSION_NAME <span class="comment">//linux xcb</span></span><br><span class="line">#elif defined VK_USE_PLATFORM_XLIB_KHR</span><br><span class="line">VK_KHR_XLIB_SURFACE_EXTENSION_NAME <span class="comment">//linux xlib</span></span><br><span class="line">#endif</span><br><span class="line">);</span><br><span class="line"><span class="keyword">return</span> CreateVulkanInstance( desired_extensions, application_name, instance</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="创建presentation-surface"><a href="#创建presentation-surface" class="headerlink" title="创建presentation surface"></a>创建presentation surface</h3><p>presentation显示软件的窗口,允许我们获取窗口的参数(比如尺寸,支持的颜色格式,请求的images数量,或者显示模式).</p>
<p>前提:windows已经创建</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">WindowParameters</span> &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> VK_USE_PLATFORM_WIN32_KHR</span></span><br><span class="line">HINSTANCE HInstance;</span><br><span class="line">HWND HWnd;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined VK_USE_PLATFORM_XLIB_KHR</span></span><br><span class="line">Display * Dpy;</span><br><span class="line">Window Window;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined VK_USE_PLATFORM_XCB_KHR</span></span><br><span class="line"><span class="keyword">xcb_connection_t</span> * Connection;</span><br><span class="line"><span class="keyword">xcb_window_t</span> Window;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> VK_USE_PLATFORM_WIN32_KHR</span></span><br><span class="line">VkWin32SurfaceCreateInfoKHR surface_create_info = &#123;</span><br><span class="line">VK_STRUCTURE_TYPE_WIN32_SURFACE_CREATE_INFO_KHR,</span><br><span class="line"><span class="literal">nullptr</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">window_parameters.HInstance,</span><br><span class="line">window_parameters.HWnd</span><br><span class="line">&#125;;</span><br><span class="line">VkResult result = vkCreateWin32SurfaceKHR( instance, &amp;surface_create_info,</span><br><span class="line"><span class="literal">nullptr</span>, &amp;presentation_surface );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined VK_USE_PLATFORM_XLIB_KHR</span></span><br><span class="line">VkXlibSurfaceCreateInfoKHR surface_create_info = &#123;</span><br><span class="line">VK_STRUCTURE_TYPE_XLIB_SURFACE_CREATE_INFO_KHR,</span><br><span class="line"><span class="literal">nullptr</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">window_parameters.Dpy,</span><br><span class="line">window_parameters.Window</span><br><span class="line">&#125;;</span><br><span class="line">VkResult result = vkCreateXlibSurfaceKHR( instance, &amp;surface_create_info,</span><br><span class="line"><span class="literal">nullptr</span>, &amp;presentation_surface );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">elif</span> defined VK_USE_PLATFORM_XCB_KHR</span></span><br><span class="line">VkXcbSurfaceCreateInfoKHR surface_create_info = &#123;</span><br><span class="line">VK_STRUCTURE_TYPE_XCB_SURFACE_CREATE_INFO_KHR,</span><br><span class="line"><span class="literal">nullptr</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">window_parameters.Connection,</span><br><span class="line">window_parameters.Window</span><br><span class="line">&#125;;</span><br><span class="line">VkResult result = vkCreateXcbSurfaceKHR( instance, &amp;surface_create_info,</span><br><span class="line"><span class="literal">nullptr</span>, &amp;presentation_surface );</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<h3 id="选择支持给定表面显示的queue-family"><a href="#选择支持给定表面显示的queue-family" class="headerlink" title="选择支持给定表面显示的queue family"></a>选择支持给定表面显示的queue family</h3><p>显示图像是通过提交特色的command到device的queue实现的.所以要求对应的queue支持.</p>
<p>目前queue family可能支持的特性有:Image presentation,graphics,compute,transfer,sparse operations.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>( <span class="keyword">uint32_t</span> index = <span class="number">0</span>; index &lt;</span><br><span class="line"><span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(queue_families.size()); ++index ) &#123;</span><br><span class="line">VkBool32 presentation_supported = VK_FALSE;</span><br><span class="line">VkResult result = vkGetPhysicalDeviceSurfaceSupportKHR( physical_device,</span><br><span class="line">index, presentation_surface, &amp;presentation_supported );</span><br><span class="line"><span class="keyword">if</span>( (VK_SUCCESS == result) &amp;&amp;</span><br><span class="line">(VK_TRUE == presentation_supported) ) &#123;</span><br><span class="line">queue_family_index = index;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>通过vkGetPhysicalDeviceSurfaceSupportKHR接口进行检查</p>
<h3 id="logical-device-with-WSI-extensions"><a href="#logical-device-with-WSI-extensions" class="headerlink" title="logical device with WSI extensions"></a>logical device with WSI extensions</h3><p>一个device-level WSI扩展允许创建一个swapchain.这是一组被presentation engine管理的images.</p>
<p>VK_KHR_swapchain</p>
<p>一个swapchain,列举了image format,images 数量(双缓存或三缓存),presentation mode(v-sync 激活/关闭).伴随着swapchain创建的images被presentation engine所有和管理.需要使用时,需要请求,绘制,归还到presentation engine.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">desired_extensions.emplace_back( VK_KHR_SWAPCHAIN_EXTENSION_NAME );</span><br><span class="line"><span class="keyword">return</span> CreateLogicalDevice( physical_device, queue_infos,</span><br><span class="line">desired_extensions, desired_features, logical_device );</span><br></pre></td></tr></table></figure>
<h3 id="选择期望的presentation-mode"><a href="#选择期望的presentation-mode" class="headerlink" title="选择期望的presentation mode"></a>选择期望的presentation mode</h3><p>vulkan的swapchain最重要的特性是将图像显示倒屏幕,也是swap’chain的设计目的.</p>
<p>有四种模式.</p>
<p>最简单的是IMMEDIATE模式.会有屏幕撕裂现象</p>
<p><img src="media/presentatinsurface1.png" alt></p>
<p>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD<br>&lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD<br>Vulkan API实现都必须支持的是FIFO模式.   </p>
<p>FIFO RELAXED是FIFO的简单变体.不同之处是RELAXED模式,只有当图像显示足够快,比刷新率还快时才会在空白期显示图像到屏幕上.如果应用程序显示了一个图像,并且从上次显示到现在所花费的时间大于两个空白周期之间的刷新时间(FIFO queue为空),图像立即显示.因此如果足够快,这里不会有撕裂,但如果绘制得比屏幕刷新慢，会出现撕裂.这个mode与OpenGL的EXT_swap_control_tear扩展类似.</p>
<p><img src="media/swapchainFIFO.png" alt></p>
<p>最后一种为mailbox模式.它可以被看做是三重缓冲.有一个只包含一个元素的队列.一个image在这个队列里等待在空白期同步显示(v-sync激活)显示.但当app显示一张image时,新的一张新的image会替换掉队列里的.所以presentation engine总是显示最新的,没有屏幕撕裂.</p>
<p><img src="media/swapchainmailbox.png" alt></p>
<p>检查可用modes.vkGetPhysicalDeviceSurfacePresentModesKHR.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> present_modes_count = <span class="number">0</span>;</span><br><span class="line">VkResult result = VK_SUCCESS;</span><br><span class="line">result = vkGetPhysicalDeviceSurfacePresentModesKHR( physical_device,</span><br><span class="line">presentation_surface, &amp;present_modes_count, <span class="literal">nullptr</span> );</span><br><span class="line"><span class="keyword">if</span>( (VK_SUCCESS != result) ||</span><br><span class="line">(<span class="number">0</span> == present_modes_count) ) &#123;</span><br><span class="line">    <span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not get the number of supported present modes."</span> &lt;&lt;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">vector</span>&lt;VkPresentModeKHR&gt; present_modes( present_modes_count );</span><br><span class="line">result = vkGetPhysicalDeviceSurfacePresentModesKHR( physical_device,</span><br><span class="line">presentation_surface, &amp;present_modes_count, &amp;present_modes[<span class="number">0</span>] );</span><br><span class="line"><span class="keyword">if</span>( (VK_SUCCESS != result) ||</span><br><span class="line">(<span class="number">0</span> == present_modes_count) ) &#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not enumerate present modes."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获得了支持的所有modes后,选择一个期望的.如果不支持则选择默认的FIFO(总被支持).</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>( <span class="keyword">auto</span> &amp; current_present_mode : present_modes ) &#123;</span><br><span class="line"><span class="keyword">if</span>( current_present_mode == desired_present_mode ) &#123;</span><br><span class="line">present_mode = desired_present_mode;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Desired present mode is not supported. Selecting default FIFO</span></span><br><span class="line"><span class="string">mode."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">for</span>( <span class="keyword">auto</span> &amp; current_present_mode : present_modes ) &#123;</span><br><span class="line"><span class="keyword">if</span>( current_present_mode == VK_PRESENT_MODE_FIFO_KHR ) &#123;</span><br><span class="line">present_mode = VK_PRESENT_MODE_FIFO_KHR;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获得一个presentation-surface的功能"><a href="#获得一个presentation-surface的功能" class="headerlink" title="获得一个presentation surface的功能"></a>获得一个presentation surface的功能</h3><p>当创建一个swapchain时,不能选择我们想要的值而是指定参数.必须提供被presentation surface支持的限制范围内的值.因此为了正确创建swapchain,我们需要获得surface的功能.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">VkResult result = vkGetPhysicalDeviceSurfaceCapabilitiesKHR(</span><br><span class="line">physical_device, presentation_surface, &amp;surface_capabilities );</span><br><span class="line"><span class="keyword">if</span>( VK_SUCCESS != result ) &#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not get the capabilities of a presentation surface."</span></span><br><span class="line">&lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>VkSurfaceCapabilitiesKHR</p>
<blockquote>
<ul>
<li>swapchain images的最小和最大允许数量</li>
<li>表面的最小、最大、当前范围</li>
<li>支持图像转换(在显示前应用),其实就是是否进行sRGB转换,可能在不同平台支持特性不同,也就是要注意是否要自己进行转换</li>
<li>image layers最大数量</li>
<li>支持的usages</li>
<li>支持曲面的alpha值(图像的alpha组件该如何影响应用程序的窗口桌面合成)的支持的组件列表</li>
</ul>
</blockquote>
<p>内容包括</p>
<blockquote>
<ul>
<li>创建一个presentation surface</li>
<li>select swapchain images的个数</li>
<li>choose swapchain images的尺寸</li>
<li>select swapchain chains的期望的usage</li>
<li>select swapchain images的transformation</li>
<li>select swapchain images的format</li>
<li>创建一个swapchain</li>
</ul>
</blockquote>
<h3 id="select-swapchain-iamges的数量"><a href="#select-swapchain-iamges的数量" class="headerlink" title="select swapchain iamges的数量"></a>select swapchain iamges的数量</h3><p>当app想向swapchain image里渲染时,必须向prsentation engine请求它.app可以请求多张images,不限制一次请求一张.但可用的images(presentation engine 没在使用的)数量与presentation mode,app当前状态(渲染、显示的历史),images数量(创建swapchain时指定(最小))有关.</p>
<p>相关结构</p>
<p>VkSurfaceCapabilitiesKHR</p>
<blockquote>
<p>.minImageCount,一般将minImageCount.+1作为请求数量</p>
<p>.maxImageCount,如果&gt;0则对能创建的images最大数量有限制,就需要修正请求的images 数量了</p>
</blockquote>
<p>伴随swapchain创经济的images主要用作显示目的.但它们也表示引擎正常工作.知道它被替换,app不能使用它(image).images立即替换现实中的image或者在队列里等待替换它(v-sync)–基于选择的mode.app只能请求处于unused 状态的image.(可以请求所有unused状态的images).但同时,需要present至少一张image,否则请求操作会死锁.</p>
<p>未使用的映像的数量主要取决于表示模式和使用swapchain创建的images的总数.因此,我们想要创建的图像的数量应该根据我们想要实现的呈现场景(应用程序想同时拥有多少图像)和所选的当前模式来选择.</p>
<p>请求最小数量的Images:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">number_of_images = surface_capabilities.minImageCount + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">if</span>( (surface_capabilities.maxImageCount &gt; <span class="number">0</span>) &amp;&amp;</span><br><span class="line">(number_of_images &gt; surface_capabilities.maxImageCount) ) &#123;</span><br><span class="line">number_of_images = surface_capabilities.maxImageCount;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>Vulkan API实现都必须支持的是FIFO模式.</p>
<p>选择需求需要的images数量</p>
<h3 id="choose-swapchain-images-size"><a href="#choose-swapchain-images-size" class="headerlink" title="choose swapchain images size *"></a>choose swapchain images size *</h3><p>通常要适合window大小,支持的dimensions再presentation surface的属性里有.但有的操作系统,iamges的size决定了最终window的大小.</p>
<p>同时也要记住去检查swapchain images的适合的dimensions.</p>
<p>相关结构</p>
<p>VkSurfaceCapabilitiesKHR</p>
<p>VkExtent2D</p>
<p>检查</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//如果surface_capabilities.currentExtent.width==-1</span></span><br><span class="line"><span class="comment">//则image的size决定windows的size</span></span><br><span class="line"><span class="keyword">if</span>( <span class="number">0xFFFFFFFF</span> == surface_capabilities.currentExtent.width ) </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//这种情况就根据surface 属性调节image size</span></span><br><span class="line">    size_of_images = &#123; <span class="number">640</span>, <span class="number">480</span> &#125;;</span><br><span class="line">    <span class="comment">//范围检查</span></span><br><span class="line">    <span class="keyword">if</span>( size_of_images.width &lt; surface_capabilities.minImageExtent.width ) </span><br><span class="line">    &#123;</span><br><span class="line">    	size_of_images.width = surface_capabilities.minImageExtent.width;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( size_of_images.width &gt;</span><br><span class="line">    surface_capabilities.maxImageExtent.width ) </span><br><span class="line">    &#123;</span><br><span class="line">    	size_of_images.width = surface_capabilities.maxImageExtent.width;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( size_of_images.height &lt; surface_capabilities.minImageExtent.height )</span><br><span class="line">    &#123;</span><br><span class="line">    	size_of_images.height = surface_capabilities.minImageExtent.height;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>( size_of_images.height &gt; surface_capabilities.maxImageExtent.height ) </span><br><span class="line">    &#123;</span><br><span class="line">    	size_of_images.height = surface_capabilities.maxImageExtent.height;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">//这种情况就将surface的size作为images的size</span></span><br><span class="line">    size_of_images = surface_capabilities.currentExtent;<span class="comment">//currentExtent是创建的windows尺寸</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>​    正常情况是将windows size作为images的size,但有的os是swapchain images的尺寸决定的.</p>
<h3 id="select-所需的swapchain-iamges使用场景"><a href="#select-所需的swapchain-iamges使用场景" class="headerlink" title="select 所需的swapchain iamges使用场景"></a>select 所需的swapchain iamges使用场景</h3><p>伴随swapchain创建的images常用作color attachments(VK_IMAGE_USAGE_COLOR_ATTACHMENT_BIT).也就是说我们想向它们渲染东西(RT).但不限于此.也有其他用处:可以进行采样,在copy操作时作为数据源,或者作为拷贝目标.这些都是在创建swapchain时的不同的使用usages,但是需要检查usages是否支持.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">image_usage = desired_usages &amp; surface_capabilities.supportedUsageFlags;</span><br><span class="line">return desired_usages == image_usage;</span><br></pre></td></tr></table></figure>
<h3 id="select-a-transformation-of-swapchain-images"><a href="#select-a-transformation-of-swapchain-images" class="headerlink" title="select a transformation of swapchain images"></a>select a transformation of swapchain images</h3><p>有的(尤其是手机)设备,images能从不同orientations看,有时需要控制图像显示到屏幕上时面向.Vulkan能做到这点,能在显示前指定图像的转换.</p>
<p>相关结构</p>
<p>VkSurfaceTransformFlagBitsKHR</p>
<p>Transformations定义了image在显示到屏幕前如何旋转、镜像.在swapchain创建时,能够指定期望的transformation和presentation engine,并作为显示过程的一部分.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( surface_capabilities.supportedTransforms &amp; desired_transform ) &#123;</span><br><span class="line">surface_transform = desired_transform;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">surface_transform = surface_capabilities.currentTransform;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="select-一种swapchain-images-格式"><a href="#select-一种swapchain-images-格式" class="headerlink" title="select 一种swapchain images 格式"></a>select 一种swapchain images 格式</h3><p>format定义了color分量的数量和每个分量的bits和数据类型.在创建swapchain时</p>
<blockquote>
<p>需要决定使用的颜色通道</p>
<p>是否使用uint或float类型</p>
<p>精度</p>
<p>线性、非线性颜色.</p>
</blockquote>
<p>​    但只能选择被支持的特性.</p>
<p>相关结构</p>
<p>VkFormat</p>
<p>VkColorSpaceKHR</p>
<p>VkSurfaceFormatKHR</p>
<p>VkSurfaceKHR</p>
<p>获得所有支持的formats,调用两次vkGetPhysicalDeviceSurfaceFormatsKHR,存在列表VkSurfaceFormatKHR里,如果只返回一个VK_FORMAT_UNDEFINED,也就是说对format没有限制.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( (<span class="number">1</span> == surface_formats.size()) &amp;&amp;</span><br><span class="line">(VK_FORMAT_UNDEFINED == surface_formats[<span class="number">0</span>].format) ) &#123;</span><br><span class="line">image_format = desired_surface_format.format;</span><br><span class="line">image_color_space = desired_surface_format.colorSpace;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当返回一系列的VkSurfaceFormatKHR时,需要选择image format好color space都支持的.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>( <span class="keyword">auto</span> &amp; surface_format : surface_formats ) &#123;</span><br><span class="line"><span class="keyword">if</span>( (desired_surface_format.format == surface_format.format) &amp;&amp;</span><br><span class="line">(desired_surface_format.colorSpace == surface_format.colorSpace) ) &#123;</span><br><span class="line">image_format = desired_surface_format.format;</span><br><span class="line">image_color_space = desired_surface_format.colorSpace;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后,如果期望公式不支持,选择第一个吧</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">image_format = surface_formats[<span class="number">0</span>].format;</span><br><span class="line">image_color_space = surface_formats[<span class="number">0</span>].colorSpace;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Desired format is not supported. Selecting available format -</span></span><br><span class="line"><span class="string">colorspace combination."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<h3 id="创建swapchain"><a href="#创建swapchain" class="headerlink" title="创建swapchain"></a>创建swapchain</h3><p>一个swapchain用于显示images到屏幕上.那是一组能被app请求并显示到app窗口上的images.它们有相同的属性(properties).当准备好所有的参数:数量,size,format,swapchain images的使用usage,选择一个支持的先试试modes,就可以创建swapchain了.</p>
<p>一个swapchain是一组Images,伴随swapchain自动创建、销毁.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">VkSwapchainCreateInfoKHR swapchain_create_info = &#123;</span><br><span class="line">VK_STRUCTURE_TYPE_SWAPCHAIN_CREATE_INFO_KHR,</span><br><span class="line"><span class="literal">nullptr</span>,</span><br><span class="line"><span class="number">0</span>,</span><br><span class="line">presentation_surface,<span class="comment">//surface</span></span><br><span class="line">image_count,<span class="comment">//minImageCount</span></span><br><span class="line">surface_format.format,</span><br><span class="line">surface_format.colorSpace,<span class="comment">//imageColorSpace</span></span><br><span class="line">image_size,</span><br><span class="line"><span class="number">1</span>,<span class="comment">//imageArrayLayers</span></span><br><span class="line">image_usage,</span><br><span class="line">VK_SHARING_MODE_EXCLUSIVE,<span class="comment">//imageSharingMode</span></span><br><span class="line"><span class="number">0</span>,<span class="comment">//queueFamilyIndexCount</span></span><br><span class="line"><span class="literal">nullptr</span>,</span><br><span class="line">surface_transform,</span><br><span class="line">VK_COMPOSITE_ALPHA_OPAQUE_BIT_KHR,</span><br><span class="line">present_mode,</span><br><span class="line">VK_TRUE,</span><br><span class="line">old_swapchain</span><br><span class="line">&#125;;</span><br><span class="line">VkResult result = vkCreateSwapchainKHR( logical_device,</span><br><span class="line">&amp;swapchain_create_info, <span class="literal">nullptr</span>, &amp;swapchain );</span><br><span class="line"><span class="keyword">if</span>( (VK_SUCCESS != result) ||</span><br><span class="line">(VK_NULL_HANDLE == swapchain) ) &#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not create a swapchain."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vkDestroySwapchainKHR</span><br></pre></td></tr></table></figure>
<p>一个app的窗口只能关联一个swapchain,当创建一个新的swapchain时,需要销毁之前为这个窗口创建的swapchain.</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( VK_NULL_HANDLE != old_swapchain ) &#123;</span><br><span class="line">vkDestroySwapchainKHR( logical_device, old_swapchain, <span class="literal">nullptr</span> );</span><br><span class="line">old_swapchain = VK_NULL_HANDLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="获得swapchain-images的handles"><a href="#获得swapchain-images的handles" class="headerlink" title="获得swapchain images的handles"></a>获得swapchain images的handles</h3><p>vkGetSwapchainImagesKHR</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">uint32_t</span> images_count = <span class="number">0</span>;</span><br><span class="line">VkResult result = VK_SUCCESS;</span><br><span class="line">result = vkGetSwapchainImagesKHR( logical_device, swapchain, &amp;images_count,</span><br><span class="line"><span class="literal">nullptr</span> );</span><br><span class="line"><span class="keyword">if</span>( (VK_SUCCESS != result) ||</span><br><span class="line">(<span class="number">0</span> == images_count) ) &#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not get the number of swapchain images."</span> &lt;&lt;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line">swapchain_images.resize( images_count );</span><br><span class="line">result = vkGetSwapchainImagesKHR( logical_device, swapchain, &amp;images_count,</span><br><span class="line">&amp;swapchain_images[<span class="number">0</span>] );</span><br><span class="line"><span class="keyword">if</span>( (VK_SUCCESS != result) ||</span><br><span class="line">(<span class="number">0</span> == images_count) ) &#123;</span><br><span class="line"><span class="built_in">std</span>::<span class="built_in">cout</span> &lt;&lt; <span class="string">"Could not enumerate swapchain images."</span> &lt;&lt; <span class="built_in">std</span>::<span class="built_in">endl</span>;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br></pre></td></tr></table></figure>
<p>驱动可能创建多余创建swapchain时传参数量的images.我们设置了最小数量,但vulkan实现时可能创建更多.</p>
<p>vulkan中,如果想绘制一个image需要有它的handle.需要创建一个包裹image的image view且在创建framebuffer时用到.framebuffer时一组在渲染过程中用到的images.</p>
<p>得到得是一个数而不是handle本身.这个数字表示使用vkGetSwapchainImagesKHR得到的images数组的索引.因此了解images总数、顺序、handles对于正确使用swapchain和images很必要.</p>
<h3 id="创建一个swapchain-R8G8B8A8-format-amp-mailbox显示模式"><a href="#创建一个swapchain-R8G8B8A8-format-amp-mailbox显示模式" class="headerlink" title="创建一个swapchain(R8G8B8A8 format &amp; mailbox显示模式)"></a>创建一个swapchain(R8G8B8A8 format &amp; mailbox显示模式)</h3><p>无transformations,标准color attachment image usage.</p>
<p>已有设施</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">VkPhysicalDevice physical_device;</span><br><span class="line">VkSurfaceKHR presentation_surface;</span><br><span class="line">VkDevice logical_device;</span><br><span class="line">VkSwapchainKHR old_swapchain;</span><br><span class="line">VkPresentModeKHR desired_present_mode;</span><br><span class="line">VkSurfaceCapabilitiesKHR surface_capabilities;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uint32_t number_of_images;</span><br><span class="line">VkExtent2D image_size;</span><br><span class="line">VkImageUsageFlags image_usage = VK_IMAGE_USAGE_COLOR_ATTACHMENT_BIT;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">VkPresentModeKHR desired_present_mode;</span><br><span class="line">if( !SelectDesiredPresentationMode( physical_device, presentation_surface,</span><br><span class="line">VK_PRESENT_MODE_MAILBOX_KHR, desired_present_mode ) ) &#123;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line">VkSurfaceCapabilitiesKHR surface_capabilities;</span><br><span class="line">if( !GetCapabilitiesOfPresentationSurface( physical_device,</span><br><span class="line">presentation_surface, surface_capabilities ) ) &#123;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line">uint32_t number_of_images;</span><br><span class="line">if( !SelectNumberOfSwapchainImages( surface_capabilities, number_of_images</span><br><span class="line">) ) &#123;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line">VkExtent2D image_size;</span><br><span class="line">if( !ChooseSizeOfSwapchainImages( surface_capabilities, image_size ) ) &#123;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line">if( (0 == image_size.width) ||</span><br><span class="line">(0 == image_size.height) ) &#123;</span><br><span class="line">	return true;</span><br><span class="line">&#125;</span><br><span class="line">VkImageUsageFlags image_usage;</span><br><span class="line">if( !SelectDesiredUsageScenariosOfSwapchainImages( surface_capabilities,</span><br><span class="line">VK_IMAGE_USAGE_COLOR_ATTACHMENT_BIT, image_usage ) ) &#123;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line">VkSurfaceTransformFlagBitsKHR surface_transform;</span><br><span class="line">SelectTransformationOfSwapchainImages( surface_capabilities,</span><br><span class="line">VK_SURFACE_TRANSFORM_IDENTITY_BIT_KHR, surface_transform );</span><br><span class="line">VkFormat image_format;</span><br><span class="line">VkColorSpaceKHR image_color_space;</span><br><span class="line">if( !SelectFormatOfSwapchainImages( physical_device, presentation_surface,</span><br><span class="line">&#123; VK_FORMAT_R8G8B8A8_UNORM, VK_COLOR_SPACE_SRGB_NONLINEAR_KHR &#125;,</span><br><span class="line">image_format, image_color_space ) ) &#123;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">if( !CreateSwapchain( logical_device, presentation_surface,</span><br><span class="line">number_of_images, &#123; image_format, image_color_space &#125;, image_size,</span><br><span class="line">image_usage, surface_transform, desired_present_mode, old_swapchain,</span><br><span class="line">swapchain ) ) &#123;</span><br><span class="line">return false;</span><br><span class="line">&#125;</span><br><span class="line">if( !GetHandlesOfSwapchainImages( logical_device, swapchain,</span><br><span class="line">swapchain_images ) ) &#123;</span><br><span class="line">return false;</span><br><span class="line">&#125;</span><br><span class="line">return true;</span><br></pre></td></tr></table></figure>
<h3 id="获得swapchain-iamge"><a href="#获得swapchain-iamge" class="headerlink" title="获得swapchain iamge"></a>获得swapchain iamge</h3><p>vkGetSwapchainImagesKHR</p>
<p>semaphores和fences</p>
<p>semphores用于同步device的queues.不能用于同步app的commands提交.</p>
<p>fences app</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">VkResult result;</span><br><span class="line">result = vkAcquireNextImageKHR( logical_device, swapchain, <span class="number">2000000000</span>,</span><br><span class="line">semaphore, fence, &amp;image_index );</span><br><span class="line"><span class="keyword">switch</span>( result ) &#123;</span><br><span class="line"><span class="keyword">case</span> VK_SUCCESS:</span><br><span class="line"><span class="keyword">case</span> VK_SUBOPTIMAL_KHR:</span><br><span class="line"><span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">default</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在immediate模式下,可能images都不可用,也就是可能失败.第三个参数是一个超时参数(ns),</p>
<p>如果要让驱动在处理commands前进行等待,semaphore会用到.</p>
<p>app侧等待性能影响更大.</p>
<p>返回值也很重要</p>
<p>如果返回VK_SUBOPTIMAL_KHR,意味着我们能用这个image,但它不再最适合presentation engine.需要重新创建swapchain.但不必立即做.</p>
<p>当返回VK_ERROR_OUT_OF_DATE_KHR时,image就不能用了,我们需要立即重建swapchain.</p>
<p>对于swapchain最后需要注意的时在能使用一张image前,我们需要改变(transition)它的layout,layout时image的内部内存组织–可能跟当前目的不同.如果想用于不同目的就修改它的layout.</p>
<p>比如,用于presentation engine的images必须有VK_IMAGE_LAYOUT_PRESENT_SRC_KHR层.如果用于渲染必须有VK_IMAGE_LAYOUT_COLOR_ATTACHMENT_OPTIMAL,改变layout的操作称为transition.</p>
<h3 id="present-an-image"><a href="#present-an-image" class="headerlink" title="present an image"></a>present an image</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">PresentInfo</span> &#123;</span></span><br><span class="line">    VkSwapchainKHR Swapchain;</span><br><span class="line">    <span class="keyword">uint32_t</span> ImageIndex;<span class="comment">//想显示的image index</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">VkPresentInfoKHR present_info = &#123;</span><br><span class="line">    VK_STRUCTURE_TYPE_PRESENT_INFO_KHR,</span><br><span class="line">    <span class="literal">nullptr</span>,</span><br><span class="line">    <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(rendering_semaphores.size()),</span><br><span class="line">    rendering_semaphores.size() &gt; <span class="number">0</span> ? &amp;rendering_semaphores[<span class="number">0</span>] : <span class="literal">nullptr</span>,</span><br><span class="line">    <span class="keyword">static_cast</span>&lt;<span class="keyword">uint32_t</span>&gt;(swapchains.size()),</span><br><span class="line">    swapchains.size() &gt; <span class="number">0</span> ? &amp;swapchains[<span class="number">0</span>] : <span class="literal">nullptr</span>,</span><br><span class="line">    swapchains.size() &gt; <span class="number">0</span> ? &amp;image_indices[<span class="number">0</span>] : <span class="literal">nullptr</span>,</span><br><span class="line">    <span class="literal">nullptr</span></span><br><span class="line">&#125;;</span><br><span class="line">result = vkQueuePresentKHR( <span class="built_in">queue</span>, &amp;present_info );</span><br><span class="line"><span class="keyword">switch</span>( result ) &#123;</span><br><span class="line">    <span class="keyword">case</span> VK_SUCCESS:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在提交image前,需要修改其layout为VK_IMAGE_LAYOUT_PRESENT_SRC_KHR否则presentation engine可能无法显示它.</p>
<p>当提交命令时,rendering_semaphores用于同步</p>
<h3 id="destroy"><a href="#destroy" class="headerlink" title="destroy"></a>destroy</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( swapchain ) &#123;</span><br><span class="line">    vkDestroySwapchainKHR( logical_device, swapchain, <span class="literal">nullptr</span> );</span><br><span class="line">    swapchain = VK_NULL_HANDLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>( presentation_surface ) &#123;</span><br><span class="line">    vkDestroySurfaceKHR( instance, presentation_surface, <span class="literal">nullptr</span> );</span><br><span class="line">    presentation_surface = VK_NULL_HANDLE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/vulkan/" rel="tag"># vulkan</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/04/05/sdk/graphics/vulkan/9.CommandRecordingandDrawing/" rel="next" title="Command Recording and Drawing">
                <i class="fa fa-chevron-left"></i> Command Recording and Drawing
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/04/05/sdk/graphics/vulkan/3.CommadnBuffersAndSynchronization/" rel="prev" title="Command Buffers and Synchronization">
                Command Buffers and Synchronization <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">nolife</p>
              <div class="site-description motion-element" itemprop="description">一个游戏程序员的blog</div>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">17</span>
                    <span class="site-state-item-name">posts</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  
                    
                      <a href="/categories/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">6</span>
                    <span class="site-state-item-name">categories</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  
                    
                      <a href="/tags/">
                    
                  
                    
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">2</span>
                    <span class="site-state-item-name">tags</span>
                  </a>
                </div>
              
            </nav>
          

          

          

          

          
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#内容"><span class="nav-number">1.</span> <span class="nav-text">内容</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#介绍"><span class="nav-number">2.</span> <span class="nav-text">介绍</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#步骤"><span class="nav-number">3.</span> <span class="nav-text">步骤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#instance-with-WSI-extensions"><span class="nav-number">3.1.</span> <span class="nav-text">instance with WSI extensions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建presentation-surface"><span class="nav-number">3.2.</span> <span class="nav-text">创建presentation surface</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#选择支持给定表面显示的queue-family"><span class="nav-number">3.3.</span> <span class="nav-text">选择支持给定表面显示的queue family</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#logical-device-with-WSI-extensions"><span class="nav-number">3.4.</span> <span class="nav-text">logical device with WSI extensions</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#选择期望的presentation-mode"><span class="nav-number">3.5.</span> <span class="nav-text">选择期望的presentation mode</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获得一个presentation-surface的功能"><span class="nav-number">3.6.</span> <span class="nav-text">获得一个presentation surface的功能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#select-swapchain-iamges的数量"><span class="nav-number">3.7.</span> <span class="nav-text">select swapchain iamges的数量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#choose-swapchain-images-size"><span class="nav-number">3.8.</span> <span class="nav-text">choose swapchain images size *</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#select-所需的swapchain-iamges使用场景"><span class="nav-number">3.9.</span> <span class="nav-text">select 所需的swapchain iamges使用场景</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#select-a-transformation-of-swapchain-images"><span class="nav-number">3.10.</span> <span class="nav-text">select a transformation of swapchain images</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#select-一种swapchain-images-格式"><span class="nav-number">3.11.</span> <span class="nav-text">select 一种swapchain images 格式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建swapchain"><span class="nav-number">3.12.</span> <span class="nav-text">创建swapchain</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获得swapchain-images的handles"><span class="nav-number">3.13.</span> <span class="nav-text">获得swapchain images的handles</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#创建一个swapchain-R8G8B8A8-format-amp-mailbox显示模式"><span class="nav-number">3.14.</span> <span class="nav-text">创建一个swapchain(R8G8B8A8 format &amp; mailbox显示模式)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#获得swapchain-iamge"><span class="nav-number">3.15.</span> <span class="nav-text">获得swapchain iamge</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#present-an-image"><span class="nav-number">3.16.</span> <span class="nav-text">present an image</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#destroy"><span class="nav-number">3.17.</span> <span class="nav-text">destroy</span></a></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      

    </div>
  </aside>
  


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">nolife</span>

  

  
</div>


  <div class="powered-by">Powered by <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> v3.8.0</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme – <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a> v7.0.1</div>




        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.1"></script>

  <script src="/js/src/motion.js?v=7.0.1"></script>



  
  


  <script src="/js/src/schemes/muse.js?v=7.0.1"></script>



  
  <script src="/js/src/scrollspy.js?v=7.0.1"></script>
<script src="/js/src/post-details.js?v=7.0.1"></script>



  


  <script src="/js/src/next-boot.js?v=7.0.1"></script>


  

  

  

  


  


  




  

  

  

  

  

  

  

  

  

  

  

  

</body>
</html>
